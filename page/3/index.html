<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>飞翔的傻瓜</title>
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="飞翔的傻瓜">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="shortcut icon" href="" />
  <link rel="icon" href="" />
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
    <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


    <script>setLoadingBarProgress(20)</script>
    <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				<!-- <i class="fa fa-home"></i> -->
				飞翔的傻瓜
			</a>

				<div class='menu'>
					<ul class='h-list'>
            
    					
    						<li>
    							<a class='nav-about flat-box' href='/'>
    								<i class='fa fa-home fa-'></i>&nbsp;主页
  								</a>
  							</li>
        			
    						<li>
    							<a class='nav-home flat-box' href='/'>
    								<i class='fa fa-rss fa-'></i>&nbsp;博客
  								</a>
  							</li>
        			
    						<li>
    							<a class='nav-archives flat-box' href='/archives'>
    								<i class='fa fa-archive fa-'></i>&nbsp;归档
  								</a>
  							</li>
        			
        		
					</ul>
					<div class='underline'></div>
				</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon"><i class="fa fa-search fa-fw"></i></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fa fa-search fa-fw" href='javascript:void(0)'></span></a></li>
				
				<li class='s-menu'><a class="fa fa-navicon fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="fa fa-comments fa-fw flat-box" href='javascript:void(0)'></a></li>
				<li class='s-top'><a class="fa fa-arrow-up fa-fw flat-box" href='javascript:void(0)'></a></li>
				<li class='s-toc'><a class="fa fa-list-ul fa-fw flat-box" href='javascript:void(0)'></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
        <div class="header">飞翔的傻瓜</div>
		<nav>
            <ul>
                
                    
                        <li>
                            <a class='nav-about flat-box nav flat-box' href='/'>
                            <i class='fa fa-home fa-fw'></i>&nbsp;主页</a>
                        </li>
                    
                        <li>
                            <a class='nav-home flat-box nav flat-box' href='/'>
                            <i class='fa fa-rss fa-fw'></i>&nbsp;博客</a>
                        </li>
                    
                        <li>
                            <a class='nav-archives flat-box nav flat-box' href='/archives'>
                            <i class='fa fa-archive fa-fw'></i>&nbsp;归档</a>
                        </li>
                    
             
            </ul>
		</nav>
	</aside>

    <script>setLoadingBarProgress(40);</script>
    <div class="l_body">
    <div class='container clearfix'>
        <div class='l_main'>
            

<section class="post-list">
    
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/08/16/struts2-1/">
                
                    struts2杂记（一）入门
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-08-16
        </time>
        
    
    <div class='cats'>
        <a href="/categories/Java/">Java</a>
    </div>


    </section>

    <section class="article typo">
        <h2 id="Struts2-配置文件"><a href="#Struts2-配置文件" class="headerlink" title="Struts2 配置文件"></a>Struts2 配置文件</h2><h3 id="常量配置"><a href="#常量配置" class="headerlink" title="常量配置"></a>常量配置</h3><p>一些默认配置在导入的<code>struts2-core.jar</code>下有<code>org.apache.struts2</code>包下的default.properties文件，里面包含了一些配置，这些配置包含编码，请求扩展名，想要相应的修改就通过在struts.xml设置常量的方式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">"struts.name.extension"</span> <span class="attr">value</span>=<span class="string">"action,do,html"</span>&gt;</span><span class="tag">&lt;/<span class="name">constant</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="result子结点"><a href="#result子结点" class="headerlink" title="result子结点"></a>result子结点</h3><p>result子节点通过name与具体的execute方法返回值比对来完成控制器的功能，其中有隐含的type属性代表响应的类型，该默认值在<code>struts-default</code>中被指明：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--struts-default.xml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"struts-default"</span> <span class="attr">abstract</span>=<span class="string">"true"</span> <span class="attr">strict-method-invocation</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result-types</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"chain"</span> <span class="attr">class</span>=<span class="string">"com.opensymphony.xwork2.ActionChainResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"dispatcher"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.ServletDispatcherResult"</span> <span class="attr">default</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"freemarker"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.views.freemarker.FreemarkerResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"httpheader"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.HttpHeaderResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"redirect"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.ServletRedirectResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"redirectAction"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.ServletActionRedirectResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"stream"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.StreamResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"velocity"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.VelocityResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"xslt"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.views.xslt.XSLTResult"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"plainText"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.PlainTextResult"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"postback"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.PostbackResult"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">result-types</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--省略其他的内容--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面对其中常用的几项做一个总结：</p>
<ul>
<li>dispatcher(默认):转发</li>
<li>redirect:重定向</li>
<li>redirectAction:重定向到一个Action</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">type</span>=<span class="string">"redirectAction"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"actionName"</span>&gt;</span>TestAction<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"namespace"</span>&gt;</span>/maoxin<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其指向的包定义为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"testPackage"</span> <span class="attr">namespace</span>=<span class="string">"/maoxin"</span> <span class="attr">extends</span>=<span class="string">"struts-defult"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"testAction"</span> <span class="attr">class</span>=<span class="string">"site.maoxin.TestAction"</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">result</span>&gt;</span>/success.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当眼重定向到Action也可以不用这个type</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"index"</span> <span class="attr">type</span>=<span class="string">"redirect"</span>&gt;</span>/maoxin/testAction.action<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>chain:转发到一个Action</p>
<p>与之上同理，但是需要注意<strong>不能通过dispacter的方式转发到一个Action</strong></p>
</li>
</ul>
<h3 id="通配符映射"><a href="#通配符映射" class="headerlink" title="通配符映射"></a>通配符映射</h3><p>通配符映射是一种方便的写result标签的方式。</p>
<p><strong>通配符映射规则</strong></p>
<ul>
<li>精确的将会覆盖不精确的，就是说明确指定的和通配符方式冲突的时候精确的会有效</li>
<li>指定的动作不存在，Struts将会尝试讲这个URI与任何一个包含通配符*的动作名进行匹配</li>
<li>被通配符匹配到的URI字符串可以用｛1｝,{2}来引用</li>
<li>{0}匹配整个URI</li>
<li>在Struts找到的带有通配符的匹配不止一个，则按照先后顺序进行匹配</li>
<li>*可以匹配0个或者多个字符，但是不包括/字符，如果想把/字符包含在内，就需要使用**，如果想要对某个字符进行转义，则需要使用 \</li>
</ul>
<p><strong>例子</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"UserAction-*"</span> <span class="attr">class</span>=<span class="string">"site.maoxin.UserAction"</span> <span class="attr">method</span>=<span class="string">"&#123;1&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"&#123;1&#125;-success"</span>&gt;</span>/success.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"&#123;1&#125;-failed"</span>&gt;</span>/failed.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">namespace</span>=<span class="string">"/test"</span> <span class="attr">extends</span>=<span class="string">"struts-default"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"User_add"</span> <span class="attr">class</span>=<span class="string">"site.maoxin.UserAction"</span> <span class="attr">method</span>=<span class="string">"add"</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">result</span>&gt;</span>/User.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"User_Delete"</span> <span class="attr">class</span>=<span class="string">"site,maoxin.UserAction"</span> <span class="attr">method</span>=<span class="string">"delete"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span>&gt;</span>/User.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"Book_add"</span> <span class="attr">class</span>=<span class="string">"site.maoxin.BookAction"</span> <span class="attr">method</span>=<span class="string">"add"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span>&gt;</span>/Book.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"Book_delete"</span> <span class="attr">class</span>=<span class="string">"site.maoxin.BookAction"</span> <span class="attr">method</span>=<span class="string">"delete"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span>&gt;</span>/Book.action<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面的类型可以通过通配符映射转换为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">namespace</span>=<span class="string">"/test"</span> <span class="attr">extends</span>=<span class="string">"struts-default"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"*_*"</span> <span class="attr">class</span>=<span class="string">"site.maoxin.&#123;1&#125;Action"</span> <span class="attr">method</span>=<span class="string">"&#123;2&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span>&gt;</span>/&#123;1&#125;.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="动态方法调用方式"><a href="#动态方法调用方式" class="headerlink" title="动态方法调用方式"></a>动态方法调用方式</h3><ul>
<li>首先需要打开动态方法调用：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">"struts.enable.DynamicMethodInvocation"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">constant</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>完成对Action的配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">class</span>=<span class="string">"site.maoxin.Test"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span>&gt;</span>/success.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>默认执行的就是execute方法，当在请求参数后面加上!后面跟上方法名就可以</p>
<h2 id="Action类"><a href="#Action类" class="headerlink" title="Action类"></a>Action类</h2><p>能够处理Struts2的请求的类，通过在struts2配置文件映射的方式来完成请求与相应action之间的关系</p>
<ul>
<li>同一个Action可以有多个响应方法</li>
<li>Action类不同于Servlet，Servlet在内存中标只有一份拷贝，而Action一次请求创建一次</li>
</ul>
<h2 id="Action-类处理Web资源"><a href="#Action-类处理Web资源" class="headerlink" title="Action 类处理Web资源"></a>Action 类处理Web资源</h2><p>Web资源也就是：HttpServletRequest，HttpSession，ServletContext等等</p>
<h3 id="与Servlet-API解耦的方式"><a href="#与Servlet-API解耦的方式" class="headerlink" title="与Servlet API解耦的方式"></a>与Servlet API解耦的方式</h3><p>所谓解耦就是不直接依赖，Struts2提供了以下方式来处理Web资源，解耦方式的缺点是：</p>
<ul>
<li>一套新的，Struts2指定的操作方式</li>
<li>功能不够齐全，不如原生方式强大</li>
</ul>
<p>下面是两种解耦的方式：</p>
<p><strong>使用 Action Context方法</strong></p>
<p><code>ActionContext</code>对象是在请求经过过滤器的时候生成的，每一个<code>ActionContext</code>通过<code>ThreadLocal</code>容器里面获得的，其中提供了对应的方法来获取。而这一切都是在<code>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</code> 过滤器中完成转换并且装入的。</p>
<ul>
<li>获取传入的request参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActionContext ac = ActionContext.getContext();</span><br><span class="line">HttpParameters hps = ac.getParameters();</span><br></pre></td></tr></table></figure>
<p>其中<code>HttpParameters</code>是实现了<code>Map&lt;String,Parameter&gt;</code>，所以用Map的方式访问，将具体的参数值封装到<code>Parameter</code>这一对象中。通过<code>Parameters.getValues</code>来获取<code>String[]</code>属性的值。</p>
<ul>
<li>获取并设置HttpServletContext域对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt;contextMap =ac.getApplication();</span><br><span class="line">contextMap.put(<span class="string">"UserCount"</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>获取并设置HttpServletSession 域对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt;sessionMap = ac.getSession();</span><br><span class="line">sessionMap.put(<span class="string">"UserName"</span>, <span class="string">"Maoxin"</span>);</span><br></pre></td></tr></table></figure>
<p>Session有一个关闭Session的问题，要操作这个域对象失效就需要提供这个方法，由于其主体还是个Map的功能，所以推断getSession返回的是一个重新实现的Map，里面包含使得Session失效的方法，运行时进行调试，可以看出其本身返回的是<code>SessionMap</code>,查看对应的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (session.getId().intern()) &#123;</span><br><span class="line">            session.invalidate();</span><br><span class="line">            session = <span class="keyword">null</span>;</span><br><span class="line">            entries = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>设置request域属性的值</p>
<p>需要注意的是<code>ActionContext</code>没有直接提供对应的方法，而之上的所有域对象本身也都是从<code>ActionContext</code>的构造方法内部的构造函数中传入的context对象得到的，而这个对象是<code>OgnlMap</code>类型，里面还有很多对象，因此，如果试图想要获取request域对象的值的话，可以通过：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt; requestMap = (Map&lt;String, Object&gt;) ac.get(<span class="string">"request"</span>);</span><br><span class="line">requestMap.put(<span class="string">"requestDispatcher"</span>, <span class="string">"转发的数据"</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>实现对应的Aware接口</strong></p>
<p>相对来说比较麻烦：</p>
<ul>
<li>首先要实现具体的接口，比如想对Application对象做操作，就要实现ApplicationAware对象接口</li>
<li>其次要在类中设置要注入对象的引用（依赖注入）</li>
<li>设置引用的getter和setter方法</li>
</ul>
<p><strong>如何选用</strong></p>
<ul>
<li>若Action对象包含多个Action方法，多个Action方法使用域对象的Map或者Parameters，则建议使用Aware接口的方式</li>
</ul>
<h3 id="与Servlet-API-耦合的方式"><a href="#与Servlet-API-耦合的方式" class="headerlink" title="与Servlet API 耦合的方式"></a>与Servlet API 耦合的方式</h3><p><strong>使用ServletActionContext</strong></p>
<ul>
<li><p>获取Request对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServletActionContext.getRequest()</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取HttpSession对象<code>getRequest().getSession()</code></p>
</li>
<li><p>获取ServletContext对象<code>getServletContext()</code></p>
</li>
</ul>
<p><strong>实现ServletXxxAware的方式</strong></p>
<p>道理同上</p>
<h2 id="默认的Action类：ActionSupport"><a href="#默认的Action类：ActionSupport" class="headerlink" title="默认的Action类：ActionSupport"></a>默认的Action类：ActionSupport</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionSupport</span> <span class="keyword">implements</span> <span class="title">Action</span>, <span class="title">Validateable</span>, <span class="title">ValidationAware</span>, <span class="title">TextProvider</span>, <span class="title">LocaleProvider</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所谓默认的Action类，其实就是result标签不绑定具体class指向的具体的类，这个具体的类同样在默认继承的包<code>struts-default.xml</code>下被指明，具体如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">default-class-ref</span> <span class="attr">class</span>=<span class="string">"com.opensymphony.xwork2.ActionSupport"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>打开<code>ActionSupport</code>类查看定义首先实现了众多接口，第一个接口是<code>Action</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUCCESS = <span class="string">"success"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NONE = <span class="string">"none"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERROR = <span class="string">"error"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INPUT = <span class="string">"input"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOGIN = <span class="string">"login"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Validateable 需要手动实现验证</li>
<li>ValidateAware</li>
<li>TextProvider</li>
<li>LocaleProvider</li>
</ul>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Java/"><i class="fa fa-tag fa-fw"></i>&nbsp;Java</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/08/05/ClassLoader总结/">
                
                    ClassLoader总结
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-08-05
        </time>
        
    
    <div class='cats'>
        <a href="/categories/Java/">Java</a>
    </div>


    </section>

    <section class="article typo">
        <p>在学习过程中，一次又一次的遇到类加载器的问题，一次又一次的重新去看，感觉有必要对ClassLoader的知识做一个详细的总结，以便于之后能熟练运用ClassLoader。</p>
<h3 id="ClassLoader是什么"><a href="#ClassLoader是什么" class="headerlink" title="ClassLoader是什么"></a>ClassLoader是什么</h3><p>类加载器，<code>.class</code>文件描述的具体信息在加载到JVM之后才能被运行和使用，加载这些文件到虚拟机的过程就是类加载的过程。JAVA本身相较于其他语言的灵活性与Java本身可以在运行期动态加载息息相关。</p>
<h3 id="类的生命周期"><a href="#类的生命周期" class="headerlink" title="类的生命周期"></a>类的生命周期</h3><ul>
<li>类加载过程<ul>
<li>加载（Loading）</li>
<li>验证（Verification）</li>
<li>准备（Preparation）</li>
<li>解析（Resolution）</li>
<li>初始化（Initialization）</li>
</ul>
</li>
<li>类使用过程<ul>
<li>使用（Using）</li>
<li>卸载（unloading）</li>
</ul>
</li>
</ul>
<p><strong>注意：</strong></p>
<p>类的解析阶段的顺序可能不按照上面自上而下的顺序，在某些情况下是在类的初始化之后开始</p>
<h3 id="类加载器的作用"><a href="#类加载器的作用" class="headerlink" title="类加载器的作用"></a>类加载器的作用</h3><ul>
<li>完成类加载过程中实线类加载的动作</li>
<li>类加载器和一个类本身一同确定一个类的唯一性<ul>
<li>判断<code>Class</code>类对象是否相等，主要包括：</li>
<li><code>Class</code>类对象的<code>equals()</code>方法</li>
<li>对象与Class类之间的<code>instanceof</code>关键字或者是<code>isInstance()</code>方法</li>
<li><code>Class</code>对象的<code>isAssignableForm()</code>方法（PS：Assignable 可分配的）</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//深入理解Java虚拟机代码清单7-7</span></span><br><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassLoader myLoader  = <span class="keyword">new</span> ClassLoader() &#123;</span><br><span class="line">	        <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Class&lt;?&gt;loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String fileName = name.substring(name.lastIndexOf(<span class="string">"."</span>)+<span class="number">1</span>)</span><br><span class="line">                        +<span class="string">".class"</span>;</span><br><span class="line">                    InputStream is = getClass().getResourceAsStream(fileName);</span><br><span class="line">                    <span class="keyword">if</span>(is==<span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">byte</span>[]b = <span class="keyword">new</span> <span class="keyword">byte</span>[is.available()];</span><br><span class="line">                    is.read(b);</span><br><span class="line">                    <span class="keyword">return</span> defineClass(name,b,<span class="number">0</span>,b.length);</span><br><span class="line">                &#125;<span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Object obj = myLoader.loadClass(<span class="string">"demo.ClassLoaderTest"</span>).newInstance();</span><br><span class="line">        System.out.println(obj.getClass());</span><br><span class="line">        System.out.println(obj <span class="keyword">instanceof</span> demo.ClassLoaderTest);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*运行结果：</span></span><br><span class="line"><span class="comment">*class demo.ClassLoaderTest</span></span><br><span class="line"><span class="comment">*false</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>上面代码注意的点是其重写的loadClass方法不满足双亲委派模型，所以能够出现不同的不同加载器加载的同名Class</li>
</ul>
<h3 id="Java的ClassLoader-分类"><a href="#Java的ClassLoader-分类" class="headerlink" title="Java的ClassLoader 分类"></a>Java的ClassLoader 分类</h3><ul>
<li><p>从Java虚拟机的角度而言，只存在两种ClassLoader</p>
<ul>
<li>启动类加载器（BootStrap ClassLoader）<ul>
<li>使用C++实现，是Java虚拟机的一部分</li>
<li>在Java程序中获取不到，会返回为null</li>
</ul>
</li>
<li>其他的类加载器<ul>
<li>独立于Java虚拟机之外</li>
<li>继承子抽象类<code>java.lang.ClassLoader</code></li>
<li>用Java语言描述</li>
</ul>
</li>
</ul>
</li>
<li><p>从开发人员角度</p>
<ul>
<li><p>启动类加载器（BootStrap ClassLoader）</p>
<ul>
<li>负责加载<code>%JAVA_HOME%\lib</code>目录中的，或者被<code>-Xbootclasspath</code>指定的路径</li>
<li>可以通过<code>System.getProperty(&quot;sun.boot.class.path&quot;)</code>查看路径</li>
</ul>
</li>
<li><p>扩展类加载器（Extension ClassLoader）</p>
<ul>
<li>由<code>sun.misc.Launcher$ExtClassLoader</code>实现</li>
<li>负责加载<code>%JAVA_HOME%\lib\ext</code>目录的类库</li>
<li><p>可以通过<code>System.getProperty(&quot;java.ext.dirs&quot;)</code>查看</p>
</li>
<li><p>可以通过参数制定路径</p>
</li>
</ul>
</li>
<li><p>应用程序类加载器（Application ClassLoader）</p>
<ul>
<li>由<code>sun.misc.Launcher$AppClassLoader</code>实现</li>
<li>负责加载用户路径上制定的类库</li>
<li>可以通过<code>System.getProperty(&quot;java.class.path&quot;)</code>查看</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看具体的路径</span></span><br><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		String paths = System.getProperty(<span class="string">"java.class.path"</span>);</span><br><span class="line">		<span class="keyword">if</span>(paths!=<span class="keyword">null</span>) &#123;</span><br><span class="line">			StringTokenizer st = <span class="keyword">new</span> StringTokenizer(paths, File.pathSeparator);</span><br><span class="line">			<span class="keyword">int</span> count = st.countTokens();</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;count;i++)</span><br><span class="line">				System.out.println(st.nextToken());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h3><p>双亲委派模型并不难，用文字解释就是：</p>
<blockquote>
<p>如果一个类加载器其收到类加载请求，首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器完成，每个层次的类加载器都是如此，因此所有的加载请求都应该传送到顶层的启动类加载器中，只有当父加载器返回自己无法完成这个加载请求的时候，子类才加载。–《深入理解Java虚拟机》</p>
</blockquote>
<p>上面的解释很标准，但是需要注意不是一拿到一个类加载请求就去加载，而是先在缓存中查看是否已经加载过了。</p>
<p>上述这些操作，在<code>ClassLoader</code>的<code>loadClass()</code>方法中定义，查看源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// 首先，检测是否已经加载</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//父加载器不为空则调用父加载器的loadClass</span></span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//父加载器为空则调用Bootstrap Classloader</span></span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                    <span class="comment">//父加载器没有找到，则调用findclass</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                <span class="comment">//调用resolveClass()</span></span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="为什么使用双亲委派？"><a href="#为什么使用双亲委派？" class="headerlink" title="为什么使用双亲委派？"></a>为什么使用双亲委派？</h3><ul>
<li>上面谈到，对JVM而言只有两种类加载器，一个是BootStrap ClassLoader，一个是Java自定义的，首先之所以分成两个正是满足Java语言在运行是时动态加载的需求。</li>
<li>如果不使用双亲委派机制，重要的基础类被恶意修改再加载到JVM引起混淆引发安全问题</li>
</ul>
<h3 id="违反双亲委派模型"><a href="#违反双亲委派模型" class="headerlink" title="违反双亲委派模型"></a>违反双亲委派模型</h3><p>首先需要明白，双亲委派模型的缺陷：（感谢知识星球（码农翻身）球友的解释）</p>
<p>补充知识：<strong>类加载器的命名空间</strong> </p>
<p>子能看见父，父却不能看见子，这就是双亲委派的弊端，<strong>当前类引用了其他类，当前类的类加载器就负责就在加载那些引用类</strong></p>
<ul>
<li>例如JDBC的DriverManager，这个类是由根加载器加载的，它里面需要调用厂商的实现类（mysql），但是mysql的jar包不在rt.jar 所在的目录里，一般都是放在项目的lib文件夹里面，根据JVM的加载规则根就没办法去加载mysql的驱动，压根就看不见实现类</li>
<li>在Thread类有个成员叫做classLoader，在<code>sun.misc.Launcher</code>类中设置该成员，其中Ext和AppClassLoader都是在这个类初始化的：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Launcher launcher = <span class="keyword">new</span> Launcher();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String bootClassPath =</span><br><span class="line">        System.getProperty(<span class="string">"sun.boot.class.path"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Launcher <span class="title">getLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> launcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Launcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Create the extension class loader</span></span><br><span class="line">        ClassLoader extcl;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extcl = ExtClassLoader.getExtClassLoader();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(</span><br><span class="line">                <span class="string">"Could not create extension class loader"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now create the class loader to use to launch the application</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            loader = AppClassLoader.getAppClassLoader(extcl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(</span><br><span class="line">                <span class="string">"Could not create application class loader"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置AppClassLoader为线程上下文类加载器</span></span><br><span class="line">        Thread.currentThread().setContextClassLoader(loader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Returns the class loader used to launch the main application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loader;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The class loader used for loading installed extensions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The class loader used for loading from java.class.path.</span></span><br><span class="line"><span class="comment">     * runs in a restricted security context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AppClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h3><ul>
<li><code>loadClass(String className,boolean isInitialized)</code>的第二个参数设置为false可以提高类加载的性能</li>
</ul>
<h3 id="类加载器的应用"><a href="#类加载器的应用" class="headerlink" title="类加载器的应用"></a>类加载器的应用</h3><p>注意事项：</p>
<p>  如果想维持双亲委派模型，我们就不应该去覆盖<code>loadClass()</code>方法,如果仅仅是想写自己的加载逻辑，应该覆盖<code>findClass()</code>完成记载逻辑，这样就可以保证双亲委派,到最后调用<code>defineClass()</code>完成相关的操作。</p>
<ul>
<li>双亲委派模型</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderA</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClassLoaderA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">		<span class="comment">//自己的findClass逻辑，如果自己的发生异常就交给默认的findClass去处理</span></span><br><span class="line">		<span class="comment">//try &#123;</span></span><br><span class="line">			</span><br><span class="line">		<span class="comment">//	return defineClass(b, off, len);</span></span><br><span class="line">		<span class="comment">//&#125;catch(..) &#123;</span></span><br><span class="line">			</span><br><span class="line">		<span class="comment">//&#125;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>违反双亲委派模型</p>
<p> 见第一个代码片段</p>
</li>
<li><p>加载一个指定包下的所有类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ClassHalper,代码源于《架构探险-从零开始写JavaWeb框架》</span></span><br><span class="line"><span class="comment">//类原型</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassUtil</span> </span>&#123;</span><br><span class="line">	<span class="comment">//ClassUtil需要的类加载器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//利用该函数加载package下面的Class文件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className,<span class="keyword">boolean</span> isInitailized)&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取Package下所有的Class文件并加载到Set中去</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSet(String packageName)&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//具体实现</span></span><br><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileFilter;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassUtil</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//使用Class.forName的形式来加载类</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className,<span class="keyword">boolean</span> isInitailized)&#123;</span><br><span class="line">		Class&lt;?&gt; cls;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			cls = Class.forName(className,isInitailized,getClassLoader());</span><br><span class="line">		&#125;<span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> cls;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSet(String packageName)&#123;</span><br><span class="line">		Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Enumeration&lt;URL&gt; urls = getClassLoader().getResources(packageName.replace(<span class="string">'.'</span>, <span class="string">'/'</span>));</span><br><span class="line">			<span class="keyword">while</span>(urls.hasMoreElements()) &#123;</span><br><span class="line">				URL url = urls.nextElement();</span><br><span class="line">				<span class="keyword">if</span>(url!=<span class="keyword">null</span>) &#123;</span><br><span class="line">					String protocal = url.getProtocol();</span><br><span class="line">					<span class="comment">//如果协议名称是file的时候就将%20转义为空格</span></span><br><span class="line">					<span class="keyword">if</span>(protocal.equals(<span class="string">"file"</span>))&#123;</span><br><span class="line">						String packagePath = url.getPath().replaceAll(<span class="string">"%20"</span>,<span class="string">""</span>);</span><br><span class="line">						<span class="comment">//调用真正执行递归添加类的方法</span></span><br><span class="line">						addClass(classSet,packagePath,packageName);</span><br><span class="line">					<span class="comment">//如果协议名称是jar的时候就用jar特有的方式读取</span></span><br><span class="line">					&#125;<span class="keyword">else</span> <span class="keyword">if</span>(protocal.equals(<span class="string">"jar"</span>)) &#123;</span><br><span class="line">						<span class="comment">//...</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(<span class="string">"get class set failure"</span>);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> classSet;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//执行根据包下路径</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addClass</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classSet,String packagePath,String packageName)</span> </span>&#123;</span><br><span class="line">		File[] files = <span class="keyword">new</span> File(packagePath).listFiles(<span class="keyword">new</span> FileFilter() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">				<span class="comment">//如果是目录，或者是以class为末尾的文件就返回true</span></span><br><span class="line">				<span class="keyword">return</span> (file.isFile()&amp;&amp;file.getName().endsWith(<span class="string">".class"</span>)||file.isDirectory());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">for</span>(File file:files) &#123;</span><br><span class="line">			<span class="comment">//如果是一个文件，就直接做处理将XXX.class的名字解析出来,组合成全类名之后加载</span></span><br><span class="line">			String fileName = file.getName();</span><br><span class="line">			<span class="keyword">if</span>(file.isFile()) &#123;</span><br><span class="line">				String className = fileName.substring(<span class="number">0</span>, fileName.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">				doAddClass(classSet,className);</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//如果是一个目录就进一步组合成进一步目录</span></span><br><span class="line">				String subPackagePath = fileName;</span><br><span class="line">				subPackagePath = packagePath+<span class="string">"/"</span>+subPackagePath;</span><br><span class="line">				<span class="comment">//这个时候的全类名就深入了一步</span></span><br><span class="line">				String subPackageName = packageName+<span class="string">"."</span>+fileName;</span><br><span class="line">				<span class="comment">//递归的进行添加</span></span><br><span class="line">				addClass(classSet,subPackagePath,subPackageName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//添加到具体的Set中去</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doAddClass</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classSet,String className)</span> </span>&#123;</span><br><span class="line">		Class&lt;?&gt; cls = loadClass(className,<span class="keyword">false</span>);</span><br><span class="line">		classSet.add(cls);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>类文件的加密与解密</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对ClassLoader的学习暂时到这里，后续会不断的补充。</p>
<blockquote>
<p>参考文章</p>
<p><a href="https://blog.csdn.net/briblue/article/details/54973413" target="_blank" rel="noopener">https://blog.csdn.net/briblue/article/details/54973413</a> 超详细java中的ClassLoader详解</p>
<p><a href="https://blog.csdn.net/zhangzeyuaaa/article/details/42499839" target="_blank" rel="noopener">https://blog.csdn.net/zhangzeyuaaa/article/details/42499839</a>  全盘负责和双亲委托</p>
<p>《码农翻身》 刘欣  电子工业出版社 </p>
</blockquote>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Java/"><i class="fa fa-tag fa-fw"></i>&nbsp;Java</a>
                
                    <a href="/tags/ClassLoader/"><i class="fa fa-tag fa-fw"></i>&nbsp;ClassLoader</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/08/01/js-1/">
                
                    蛋疼的JavaScript(一)：作用域与闭包
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-08-01
        </time>
        
    
    <div class='cats'>
        <a href="/categories/JavaScript/">JavaScript</a>
    </div>


    </section>

    <section class="article typo">
        <p>在使用JavaScript的时候各种奇葩的结果真的让人头大，于是系统的学习一下JavaScript的一些知识。深入了解下JavaScript。（注：以下均为浅尝则止）</p>
<h2 id="JavaScript-的坑"><a href="#JavaScript-的坑" class="headerlink" title="JavaScript 的坑"></a>JavaScript 的坑</h2><p>创建变量的时候，我们一般用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>JS引擎在看到上述代码的时候会做两步操作</p>
<ul>
<li>创建符号a对应的内存空间（解释阶段）</li>
<li>将基本类型2放置到a对应的内存空间当中（执行阶段）</li>
</ul>
<p>也就是说var 带有声明变量的作用，如果有以下代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>JS解释器先发现了符号a，试图去找a的内存地址在哪，没有找到，它不会返回给程序员什么错误，而是自作主张在顶层作用域内创建了a的符号，再执行a=2的操作，其他语言不是这样的，不了解这个过程使用JS就是噩梦的开始。。(处理不好就会导致符号的泄漏)</p>
<p>注意到上面的a都是被赋值的对象。如果a作为右值呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b = a;</span><br></pre></td></tr></table></figure>
<p>这个时候JS引擎就不能自作主张的生成全局变量a，因为a的值不确定，这个时候它查找a符号没有找到，就乖乖的告诉你<code>a is not defined</code> </p>
<p>这是作为左值和右值的区别，我们应该将左和右概念更泛化一下。</p>
<ul>
<li>左值就是符号被赋值的过程</li>
<li>右值就是符号内容取得的过程</li>
</ul>
<p>那么很快就能反应过来函数调用的函数参数的传入是一个符号作为右值传入的过程，这就够了。</p>
<p>换个角度讲，作为左值符号未声明的时候自动创建也可以叫一个特性，如果我们指定其在哪个作用域中查找符号，这样就可以动态的添加属性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> A=&#123;</span><br><span class="line">    name:<span class="string">"Maoxin"</span></span><br><span class="line">&#125;;</span><br><span class="line">A.age = <span class="number">18</span>;</span><br><span class="line"><span class="built_in">console</span>.dir(A)</span><br></pre></td></tr></table></figure>
<h3 id="符号作用域"><a href="#符号作用域" class="headerlink" title="符号作用域"></a>符号作用域</h3><p>前面就提到全局作用域，这相当于一个全局变量，而有其他语言经验的我们也知道局部变量。在重名情况下符号是就近原则，内部的能访问到外部的定义的变量，而这一切的原因其实就是压栈，函数调用的时候栈的提升，之前的变量在栈底，新的局部变量在栈提升的这部分中，所以子函数作用域能够访问到外部的作用域是合情合理的，这JavaScript也一样，但是唯一不一样的是对类似if分支，循环等等的处理。我们在使用类似C/C++/Java中，这么用是不可以的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> args,<span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d"</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d"</span>,i);<span class="comment">//错！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为循环这个东西内部创建的变量就像一个函数的作用域一样，但是JS不是这样的。在JS中允许如下代码是可以的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(i)</span><br></pre></td></tr></table></figure>
<p>原因在于循环变量</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是创建在这个块作用域之外的。。</p>
<p>这样显然对于从其他语言迁移过来的很不好使，怎么创建一个就像之前语言的变量一样的东西呢？其实可以使用ES6引入的let</p>
<h3 id="let-const-与-var"><a href="#let-const-与-var" class="headerlink" title="let const 与 var"></a>let const 与 var</h3><ul>
<li>let 可以创建一个块作用域的变量</li>
<li>const 也是块作用域的变量，不过就像其他语言的const一样，赋值之后不可修改</li>
<li>var 。。略</li>
</ul>
<p>等下，let是ES6引入的，难道，之前用JS要时时刻刻被这个问题困扰？他们是怎么解决的。</p>
<p>下面是一个实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.write(i+<span class="string">'&lt;br&gt;'</span>)</span><br><span class="line">    &#125;,i*<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行这个实例，刚开始会和惊讶，怎么输出的都是6？</p>
<p>只要知道setTimeout是异步的，不会立即执行</p>
<p>，在结合上面的内容就清楚了原因。原因就是，for都执行完了之后i=6，那么我们怎么让他正常一些？问题的根源就在于其i的作用域，我们<strong>引用了外部的i</strong>，这个i的值已经是6了。JS和其他语言的不同之处就是在块作用域的表现不同。函数作用域还是可以的，于是我们可以尝试这么改进，每次传入的i值都将其拷贝一份放在一个更小的作用域中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)&#123;</span><br><span class="line">    (<span class="function"><span class="keyword">function</span>(<span class="params">i</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> j = i;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.write(j+<span class="string">'&lt;br&gt;'</span>)</span><br><span class="line">        &#125;,i*<span class="number">1000</span>)</span><br><span class="line">    &#125;)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>猛地看挺奇怪的，但要是说明白了（函数）(参数)这种形式就是将一个参数传入即将执行的函数中去就会好明白一些，我们就是强行再加了一个函数作用域将这个i当前的值保护起来放置在j中。</p>
<p>当然现在不用这么麻烦：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.write(i+<span class="string">'&lt;br&gt;'</span>)</span><br><span class="line">    &#125;,i*<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们之前说了很多都是作用域从大到小，内部的能看到外部的。但是回顾上面的过程，我们发现一个很有趣的现象，尽管块内的函数已经执行完了，setTimeout函数却记得它内部需要引用外部的值。这表示那些看似执行完的块的某些值并没有随着执行完毕而被垃圾回收，这就是闭包。</p>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><blockquote>
<p>当函数可以记住并访问所在词法作用域的时，就产生了闭包，及时函数是在当前词法作用域之外进行的。–《你不知道的JavaScript上》</p>
</blockquote>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/JavaScript/"><i class="fa fa-tag fa-fw"></i>&nbsp;JavaScript</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/07/29/Java验证码图片创建/">
                
                    Java验证码图片创建
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-07-29
        </time>
        
    
    <div class='cats'>
        <a href="/categories/Java/">Java</a>
    </div>


    </section>

    <section class="article typo">
        <p>最近需要实现一个验证码生成工具类，之前完全没有接触过Java图形方面的知识，临时上网查阅资料，总结下自己学到的内容，到最后学习实现一个自己可以用的上的工具类,所有参阅的资料都在文末的引用部分。</p>
<h3 id="java-awt下的Image类与BufferedImage"><a href="#java-awt下的Image类与BufferedImage" class="headerlink" title="java.awt下的Image类与BufferedImage"></a>java.awt下的Image类与BufferedImage</h3><ul>
<li>java.awt.Image ：抽象类Image是表示图形图像的所有类的超类</li>
<li>java.awt.image.BufferedImage 是Image的子类，描述具有可访问图像数据缓冲区的Image</li>
</ul>
<p>总得来说，Image通常用来获取图片，BufferedImage做图片修改操作如大小变换等 </p>
<h3 id="Graphics-与Graphics2D"><a href="#Graphics-与Graphics2D" class="headerlink" title="Graphics 与Graphics2D"></a>Graphics 与Graphics2D</h3><p>Graphics类是所有的图像上下文类的抽象基类，这些图形上下文允许应用程序绘制在各种设备上实现的组件以及屏幕外的图像上。 </p>
<p>图形对象封装了Java支持的基本呈现操作所需的状态信息。</p>
<p>Graphics2D 类扩展 Graphics 类，以提供对几何形状、坐标转换、颜色管理和文本布局更为复杂的控制。它是用于在 Java(tm) 平台上呈现二维形状、文本和图像的基础类</p>
<p><strong>获取Graphics对象</strong></p>
<ul>
<li>通过继承BufferedImage对象实例获得：BufferedImage.createGraphics()/getGraphics();</li>
<li>继承Swing组建的paintComponent(Graphics g)方法</li>
</ul>
<p><strong>转型为Graphics2D 对象</strong></p>
<p>Graphics2D可以通过<code>setRenderingHint(RenderingHints.key,RenderingHints.value)</code>方法是否设置图形反锯齿、文字反锯齿、设置图像的插入方法、绘制方法、是否支持抖动等属性。 </p>
<p><strong>stroke 属性</strong></p>
<p>stroke属性用于控制线条的宽度、笔形样式、线段连接方式或短划线图案。</p>
<p>如果我们要设置stroke属性，则应当先创建Stroke引用的对象，但由于Stroke为接口类型，所以我们要创建对象，可以创建其已知实现类BasicStroke的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g2d.setStroke(<span class="keyword">new</span> BasicStroke(<span class="keyword">float</span> width,<span class="keyword">int</span> cap,<span class="keyword">int</span> join));</span><br></pre></td></tr></table></figure>
<ul>
<li>width 笔画的宽度</li>
<li>cap 端点的样式</li>
<li>join是两线段交汇的连接方式</li>
</ul>
<p>（具体详细解释请查看文末引用原博主博客）</p>
<p><strong>clip属性</strong></p>
<p>clip属性用于实现剪裁效果。设置剪裁属性可调用如下方法确定剪裁区的Shape</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setClip</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>paint属性</strong></p>
<p>paint属性控制填充效果，通过调用setPaint()方法设置： 其函数传入对应的Paint对象</p>
<p>注意：</p>
<ul>
<li>paint可以同时作用在边线和填充上，可以是单色，渐变和图案，任何paint都需要实现java.awt.Paint接口 </li>
<li>因为Color类实现了java.awt.Paint接口，所有的Color对象都是Paint对象。 </li>
</ul>
<p>一些特殊的Paint类：</p>
<ul>
<li><p>GradientPaint类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GradientPaint</span><span class="params">(<span class="keyword">float</span> x1, <span class="keyword">float</span> y1, Color color1,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">float</span> x2, <span class="keyword">float</span> y2, Color color2)</span></span></span><br></pre></td></tr></table></figure>
<p>这个类用颜色渐变填充一个区域，构造函数指定定比例和颜色。图形引擎会从第一个点到第二个点之间线性变化两个颜色：从(x1,y1)到(x2,y2)颜色从c1渐变到c2。我们还可以指定颜色图案是否允许重复。 </p>
</li>
<li><p>TexturePaint类： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TexturePaint</span><span class="params">(BufferedImage txtr, Rectangle2D anchor)</span></span></span><br></pre></td></tr></table></figure>
<p>这个类平铺一个图像来填充图形，构造函数接收一个java.awt.image.BufferedImage和一个Rectangle2D，把图像影射到矩形里，然后平铺矩形。</p>
<p>我们可以先创建GradientPaint类或TexturePaint类的对象，再调用Graphics2D的setPaint()方法设置填充效果。</p>
</li>
</ul>
<p><strong>Font属性</strong></p>
<p>所有的文本都使用能表现文字的样式图形渲染。当前的字体决定了字体的形状。使用继承自java.awt.Graphics的getFont()方法和setFont()方法来操纵字体。 </p>
<p><strong>Transform属性</strong></p>
<p>transform属性用来实现常用的图形平移、缩放和斜切等变换操作。我们可以调用setTransform()来设置transform属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setTransform</span><span class="params">(AffineTransform Tx)</span></span></span><br></pre></td></tr></table></figure>
<p>该方法需要一个AffineTransform对象的参数，所以首先创建AffineTransform对象，然后调用setTransform()方法设置transform属性。最后，用具有指定属性的Graphics2D对象绘制图形。</p>
<p>创建AffineTransform对象的方法有：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 旋转变换，旋转theta弧度</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AffineTransform <span class="title">getRotateInstance</span><span class="params">(<span class="keyword">double</span> theta)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 绕旋转中心(anchorx, anchory)旋转</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AffineTransform <span class="title">getRotateInstance</span><span class="params">(<span class="keyword">double</span> theta, <span class="keyword">double</span> anchorx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">double</span> anchory)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 缩放变换，x和y方向分别按sx,sy比例变换</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AffineTransform <span class="title">getScaleInstance</span><span class="params">(<span class="keyword">double</span> sx, <span class="keyword">double</span> sy)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 错切变换，shx和shy指定斜拉度</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AffineTransform <span class="title">getShearInstance</span><span class="params">(<span class="keyword">double</span> shx, <span class="keyword">double</span> shy)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 平移变换，tx和ty表示x和y方向平移距离</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AffineTransform <span class="title">getTranslateInstance</span><span class="params">(<span class="keyword">double</span> tx, <span class="keyword">double</span> ty)</span></span></span><br></pre></td></tr></table></figure>
<p>当然，也可以先创建一个没有transform属性的AffineTransform对象，然后用以下方法指定图形平移、旋转、缩放变换属性： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将图形在x轴方向平移tx像素，y轴方向平移ty像素</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">translate</span><span class="params">(<span class="keyword">double</span> tx, <span class="keyword">double</span> ty)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 旋转theta弧度</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">(<span class="keyword">double</span> theta)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 图形以点(anchorx, anchory)为轴点，旋转theta弧度</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">(<span class="keyword">double</span> theta, <span class="keyword">double</span> anchorx, <span class="keyword">double</span> anchory)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 图形在x轴方向缩放sx倍，纵向缩放sy倍</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scale</span><span class="params">(<span class="keyword">double</span> sx, <span class="keyword">double</span> sy)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>composit属性</strong></p>
<p>composit属性设置图形重叠区域的效果。可通过调用setComposite()方法设置该属性： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setComposite</span><span class="params">(Composite comp)</span></span></span><br></pre></td></tr></table></figure>
<p>例如先用方法AlphaComposite.getInstance(int rule, float alpha)得到AlphaComposite对象，再通过setComposite()方法设置混合效果。AlphaComposite在图形和图像中实现混合和透明效果，Alpha值的范围为0.0f(完全透明)-1.0f(完全不透明)。 </p>
<hr>
<h3 id="使用Graphics2D绘图"><a href="#使用Graphics2D绘图" class="headerlink" title="使用Graphics2D绘图"></a>使用Graphics2D绘图</h3><p>Graphics2D类仍然保留Graphics类的绘图方法，同时增加了许多新方法。新方法将几何图形(线段、圆等)作为一个对象来绘制。在java.awt.geom包中声明的一系列类，分别用于创建各种身体图形对象。常用的主要有：</p>
<ul>
<li>Line2D - 线段类</li>
<li>RoundRectangle2D - 圆角矩形类</li>
<li>Ellipse2D - 椭圆类</li>
<li>Arc2D - 圆弧类</li>
<li>QuadCurve2D - 二次曲线类</li>
<li>CubicCurve2D - 三次曲线类。</li>
</ul>
<p>要用Graphics2D类的新方法画一个图形。先在重画方法paintComponent()或paint()中，把参数对象g强制转换成Graphics2D对象；然后，用上述图形类提供的静态内部类构造方法Double()或Float()创建该图形的对象；最后，以图形对象为参数调用Graphics2D对象的draw()方法绘制这个图形。</p>
<p>画一条线段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 画线 */</span></span><br><span class="line">Stroke s = <span class="keyword">new</span> BasicStroke(<span class="number">20</span>, BasicStroke.CAP_ROUND, BasicStroke.JOIN_MITER);</span><br><span class="line">g2d.setStroke(s);       </span><br><span class="line">Line2D line = <span class="keyword">new</span> Line2D.Double(<span class="number">30</span>,<span class="number">50</span>,<span class="number">100</span>,<span class="number">200</span>);</span><br><span class="line">g2d.draw(line);</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>画一个圆角矩形：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 画圆角矩形 */</span></span><br><span class="line">g2d.setColor(Color.BLUE);</span><br><span class="line">RoundRectangle2D rect = <span class="keyword">new</span> RoundRectangle2D.Double(<span class="number">100</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">50</span>,</span><br><span class="line">            <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">g2d.draw(rect);</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>画一个旋转一定角度的矩形：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 画旋转一定角度的矩形 */</span></span><br><span class="line">Rectangle2D rect2 = <span class="keyword">new</span> Rectangle2D.Double(<span class="number">60</span>, <span class="number">160</span>, <span class="number">60</span>, <span class="number">90</span>);</span><br><span class="line">AffineTransform transform = <span class="keyword">new</span> AffineTransform();</span><br><span class="line">transform.rotate(<span class="number">45</span> * Math.PI / <span class="number">180</span>, <span class="number">90</span>, <span class="number">200</span>); <span class="comment">// 围绕(90,200)点旋转图形45度</span></span><br><span class="line">g2d.setTransform(transform);</span><br><span class="line">g2d.draw(rect2);</span><br></pre></td></tr></table></figure>
<p><strong>消除锯齿</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line">g2.setRenderingHint(RenderingHints.KEY_STROKE_CONTROL, RenderingHints.VALUE_STROKE_DEFAULT);</span><br></pre></td></tr></table></figure></p>
<p>注意：绘制完图像后记得用dispose()方法释放资源</p>
<h3 id="验证码生成的实现"><a href="#验证码生成的实现" class="headerlink" title="验证码生成的实现"></a>验证码生成的实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//验证码原实现博主是CSDN的The...Exception的大佬，在这里做了简单的修改以及添加了大量的注释来巩固上面的知识。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.Color;</span><br><span class="line"><span class="keyword">import</span> java.awt.Font;</span><br><span class="line"><span class="keyword">import</span> java.awt.Graphics;</span><br><span class="line"><span class="keyword">import</span> java.awt.Graphics2D;</span><br><span class="line"><span class="keyword">import</span> java.awt.LinearGradientPaint;</span><br><span class="line"><span class="keyword">import</span> java.awt.Paint;</span><br><span class="line"><span class="keyword">import</span> java.awt.RenderingHints;</span><br><span class="line"><span class="keyword">import</span> java.awt.geom.AffineTransform;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerifyCodeUtils</span></span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">//使用到Algerian字体，系统里没有的话需要安装字体，字体只显示大写，去掉了1,0,i,o几个容易混淆的字符</span></span><br><span class="line">	<span class="comment">//这个也是默认的字符源</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VERIFY_CODES = <span class="string">"23456789ABCDEFGHJKLMNPQRSTUVWXYZ"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 使用系统默认字符源生成验证码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> verifySize	验证码长度</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateVerifyCode</span><span class="params">(<span class="keyword">int</span> verifySize)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> generateVerifyCode(verifySize, VERIFY_CODES);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 使用指定源生成验证码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> verifySize	验证码长度</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sources	验证码字符源</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateVerifyCode</span><span class="params">(<span class="keyword">int</span> verifySize, String sources)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(sources == <span class="keyword">null</span> || sources.length() == <span class="number">0</span>)&#123;</span><br><span class="line">			sources = VERIFY_CODES;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> codesLen = sources.length();</span><br><span class="line">		<span class="comment">//用当前时间作为随机生成种子在一定程度上达到了真随机</span></span><br><span class="line">		Random rand = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line">		<span class="comment">//使用StringBuilder做到不断的附加随机字符</span></span><br><span class="line">		StringBuilder verifyCode = <span class="keyword">new</span> StringBuilder(verifySize);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; verifySize; i++)&#123;</span><br><span class="line">			verifyCode.append(sources.charAt(rand.nextInt(codesLen-<span class="number">1</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> verifyCode.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成随机验证码文件,并返回验证码值</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> outputFile</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> verifySize</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">outputVerifyImage</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, File outputFile, <span class="keyword">int</span> verifySize)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		String verifyCode = generateVerifyCode(verifySize);</span><br><span class="line">		outputImage(w, h, outputFile, verifyCode);</span><br><span class="line">		<span class="keyword">return</span> verifyCode;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 输出随机验证码图片流,并返回验证码值</span></span><br><span class="line"><span class="comment">	 * 先生成具体的随机验证码，再去生成对应的图片</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> os</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> verifySize</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">outputVerifyImage</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, OutputStream os, <span class="keyword">int</span> verifySize)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		String verifyCode = generateVerifyCode(verifySize);</span><br><span class="line">		outputImage(w, h, os, verifyCode);</span><br><span class="line">		<span class="keyword">return</span> verifyCode;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成指定验证码图像文件</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> outputFile</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">//生成图片保存的位置,抛出异常通知上层</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">outputImage</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, File outputFile, String code)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		<span class="comment">//没有输出文件的情况下先退出</span></span><br><span class="line">		<span class="keyword">if</span>(outputFile == <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//由于File中的路径直接使用mkDir生成的都是文件夹，因此需要先找到父文件夹先判断生成文件夹</span></span><br><span class="line">		File dir = outputFile.getParentFile();</span><br><span class="line">		<span class="keyword">if</span>(!dir.exists())&#123;</span><br><span class="line">			dir.mkdirs();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//再去生成具体的文件</span></span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			outputFile.createNewFile();</span><br><span class="line">			FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(outputFile);</span><br><span class="line">			outputImage(w, h, fos, code);</span><br><span class="line">			fos.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">			<span class="keyword">throw</span> e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 输出指定验证码图片流</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> w</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> os</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">outputImage</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, OutputStream os, String code)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> verifySize = code.length();</span><br><span class="line">		<span class="comment">//创建BufferedImage</span></span><br><span class="line">		BufferedImage image = <span class="keyword">new</span> BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">		Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">		<span class="comment">//获取Graphics2D对象</span></span><br><span class="line">		Graphics2D g2 = image.createGraphics();</span><br><span class="line">		<span class="comment">//设置抗锯齿</span></span><br><span class="line">		g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line">		<span class="comment">//Colors数组</span></span><br><span class="line">		Color[] colors = <span class="keyword">new</span> Color[<span class="number">5</span>];</span><br><span class="line">		<span class="comment">//ColorSpaces数组</span></span><br><span class="line">		Color[] colorSpaces = <span class="keyword">new</span> Color[] &#123; Color.WHITE, Color.CYAN,</span><br><span class="line">				Color.GRAY, Color.LIGHT_GRAY, Color.MAGENTA, Color.ORANGE,</span><br><span class="line">				Color.PINK, Color.YELLOW &#125;;</span><br><span class="line">		<span class="keyword">float</span>[] fractions = <span class="keyword">new</span> <span class="keyword">float</span>[colors.length];</span><br><span class="line">		<span class="comment">//随机从ColorSpace找到五种颜色和五个</span></span><br><span class="line">		<span class="comment">//TODO </span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; colors.length; i++)&#123;</span><br><span class="line">			colors[i] = colorSpaces[rand.nextInt(colorSpaces.length)];</span><br><span class="line">			fractions[i] = rand.nextFloat();</span><br><span class="line">		&#125;</span><br><span class="line">		Arrays.sort(fractions);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//绘制背景，之后只保留一部分，所以是绘制边框</span></span><br><span class="line">		g2.setColor(Color.GRAY);<span class="comment">// 设置边框色</span></span><br><span class="line">		g2.fillRect(<span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line">		</span><br><span class="line">		Color c = getRandColor(<span class="number">200</span>, <span class="number">250</span>);</span><br><span class="line">		g2.setColor(c);<span class="comment">// 设置背景色</span></span><br><span class="line">		g2.fillRect(<span class="number">0</span>, <span class="number">2</span>, w, h-<span class="number">4</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//绘制干扰线</span></span><br><span class="line">		Random random = <span class="keyword">new</span> Random();</span><br><span class="line">		g2.setColor(getRandColor(<span class="number">160</span>, <span class="number">200</span>));<span class="comment">// 设置线条的颜色</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">int</span> x = random.nextInt(w - <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">int</span> y = random.nextInt(h - <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">int</span> xl = random.nextInt(<span class="number">6</span>) + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">int</span> yl = random.nextInt(<span class="number">12</span>) + <span class="number">1</span>;</span><br><span class="line">			g2.drawLine(x, y, x + xl + <span class="number">40</span>, y + yl + <span class="number">20</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 添加噪点</span></span><br><span class="line">		<span class="keyword">float</span> yawpRate = <span class="number">0.05f</span>;<span class="comment">// 噪声率</span></span><br><span class="line">		<span class="keyword">int</span> area = (<span class="keyword">int</span>) (yawpRate * w * h);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; area; i++) &#123;</span><br><span class="line">			<span class="keyword">int</span> x = random.nextInt(w);</span><br><span class="line">			<span class="keyword">int</span> y = random.nextInt(h);</span><br><span class="line">			<span class="keyword">int</span> rgb = getRandomIntColor();</span><br><span class="line">			image.setRGB(x, y, rgb);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		shear(g2, w, h, c);<span class="comment">// 使图片扭曲</span></span><br><span class="line">		<span class="comment">//设置字体颜色</span></span><br><span class="line">		g2.setColor(getRandColor(<span class="number">100</span>, <span class="number">160</span>));</span><br><span class="line">		<span class="keyword">int</span> fontSize = h-<span class="number">4</span>;</span><br><span class="line">		Font font = <span class="keyword">new</span> Font(<span class="string">"Algerian"</span>, Font.ITALIC, fontSize);</span><br><span class="line">		g2.setFont(font);</span><br><span class="line">		<span class="keyword">char</span>[] chars = code.toCharArray();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; verifySize; i++)&#123;</span><br><span class="line">			AffineTransform affine = <span class="keyword">new</span> AffineTransform();</span><br><span class="line">			affine.setToRotation(Math.PI / <span class="number">4</span> * rand.nextDouble() * (rand.nextBoolean() ? <span class="number">1</span> : -<span class="number">1</span>), (w / verifySize) * i + fontSize/<span class="number">2</span>, h/<span class="number">2</span>);</span><br><span class="line">			g2.setTransform(affine);</span><br><span class="line">			g2.drawChars(chars, i, <span class="number">1</span>, ((w-<span class="number">10</span>) / verifySize) * i + <span class="number">5</span>, h/<span class="number">2</span> + fontSize/<span class="number">2</span> - <span class="number">10</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//清除</span></span><br><span class="line">		g2.dispose();</span><br><span class="line">		ImageIO.write(image, <span class="string">"jpg"</span>, os);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//生成一个随机的颜色，在bc-fc是其RGB分量的范围</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Color <span class="title">getRandColor</span><span class="params">(<span class="keyword">int</span> fc, <span class="keyword">int</span> bc)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//对输入参数进行过滤</span></span><br><span class="line">		<span class="keyword">if</span> (fc &gt; <span class="number">255</span>)</span><br><span class="line">			fc = <span class="number">255</span>;</span><br><span class="line">		<span class="keyword">if</span> (bc &gt; <span class="number">255</span>)</span><br><span class="line">			bc = <span class="number">255</span>;</span><br><span class="line">		<span class="keyword">int</span> r = fc + random.nextInt(bc - fc);</span><br><span class="line">		<span class="keyword">int</span> g = fc + random.nextInt(bc - fc);</span><br><span class="line">		<span class="keyword">int</span> b = fc + random.nextInt(bc - fc);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Color(r, g, b);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//用int类型值去保存RGB三个分量，这里用到左移，之后用逻辑加进行处理</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRandomIntColor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span>[] rgb = getRandomRgb();</span><br><span class="line">		<span class="keyword">int</span> color = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> c : rgb) &#123;</span><br><span class="line">			color = color &lt;&lt; <span class="number">8</span>;</span><br><span class="line">			color = color | c;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> color;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//生成随机颜色，RGB分量由数组保存</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] getRandomRgb() &#123;</span><br><span class="line">		<span class="keyword">int</span>[] rgb = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">			rgb[i] = random.nextInt(<span class="number">255</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> rgb;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shear</span><span class="params">(Graphics g, <span class="keyword">int</span> w1, <span class="keyword">int</span> h1, Color color)</span> </span>&#123;</span><br><span class="line">		shearX(g, w1, h1, color);</span><br><span class="line">		shearY(g, w1, h1, color);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shearX</span><span class="params">(Graphics g, <span class="keyword">int</span> w1, <span class="keyword">int</span> h1, Color color)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">int</span> period = random.nextInt(<span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">boolean</span> borderGap = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">int</span> frames = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> phase = random.nextInt(<span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; h1; i++) &#123;</span><br><span class="line">			<span class="keyword">double</span> d = (<span class="keyword">double</span>) (period &gt;&gt; <span class="number">1</span>)</span><br><span class="line">					* Math.sin((<span class="keyword">double</span>) i / (<span class="keyword">double</span>) period</span><br><span class="line">							+ (<span class="number">6.2831853071795862</span>D * (<span class="keyword">double</span>) phase)</span><br><span class="line">							/ (<span class="keyword">double</span>) frames);</span><br><span class="line">			g.copyArea(<span class="number">0</span>, i, w1, <span class="number">1</span>, (<span class="keyword">int</span>) d, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (borderGap) &#123;</span><br><span class="line">				g.setColor(color);</span><br><span class="line">				g.drawLine((<span class="keyword">int</span>) d, i, <span class="number">0</span>, i);</span><br><span class="line">				g.drawLine((<span class="keyword">int</span>) d + w1, i, w1, i);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shearY</span><span class="params">(Graphics g, <span class="keyword">int</span> w1, <span class="keyword">int</span> h1, Color color)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">int</span> period = random.nextInt(<span class="number">40</span>) + <span class="number">10</span>; <span class="comment">// 50;</span></span><br><span class="line"> </span><br><span class="line">		<span class="keyword">boolean</span> borderGap = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">int</span> frames = <span class="number">20</span>;</span><br><span class="line">		<span class="keyword">int</span> phase = <span class="number">7</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; w1; i++) &#123;</span><br><span class="line">			<span class="keyword">double</span> d = (<span class="keyword">double</span>) (period &gt;&gt; <span class="number">1</span>)</span><br><span class="line">					* Math.sin((<span class="keyword">double</span>) i / (<span class="keyword">double</span>) period</span><br><span class="line">							+ (<span class="number">6.2831853071795862</span>D * (<span class="keyword">double</span>) phase)</span><br><span class="line">							/ (<span class="keyword">double</span>) frames);</span><br><span class="line">			g.copyArea(i, <span class="number">0</span>, <span class="number">1</span>, h1, <span class="number">0</span>, (<span class="keyword">int</span>) d);</span><br><span class="line">			<span class="keyword">if</span> (borderGap) &#123;</span><br><span class="line">				g.setColor(color);</span><br><span class="line">				g.drawLine(i, (<span class="keyword">int</span>) d, i, <span class="number">0</span>);</span><br><span class="line">				g.drawLine(i, (<span class="keyword">int</span>) d + h1, i, h1);</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		File dir = <span class="keyword">new</span> File(<span class="string">"verifies"</span>);</span><br><span class="line">		<span class="keyword">int</span> w = <span class="number">200</span>, h = <span class="number">80</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">			String verifyCode = generateVerifyCode(<span class="number">4</span>);</span><br><span class="line">			File file = <span class="keyword">new</span> File(dir, verifyCode + <span class="string">".jpg"</span>);</span><br><span class="line">			outputImage(w, h, file, verifyCode);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考资料：</p>
<p><a href="https://bbs.csdn.net/topics/250022320" target="_blank" rel="noopener">https://bbs.csdn.net/topics/250022320</a> </p>
<p>BufferedImage与Buffer的区别</p>
<p><a href="https://docs.oracle.com/javase/7/docs/api/java/awt/Graphics.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/api/java/awt/Graphics.html</a></p>
<p>Graphics文档</p>
<p><a href="https://blog.csdn.net/zlxtk/article/details/53995049" target="_blank" rel="noopener">https://blog.csdn.net/zlxtk/article/details/53995049</a></p>
<p>Java Graphics初探</p>
<p><a href="https://blog.csdn.net/zhliro/article/details/45645569" target="_blank" rel="noopener">https://blog.csdn.net/zhliro/article/details/45645569</a></p>
<p>Java Graphics2D类的绘图方法</p>
<p><a href="https://blog.csdn.net/ruixue0117/article/details/22829557" target="_blank" rel="noopener">https://blog.csdn.net/ruixue0117/article/details/22829557</a></p>
<p>Java生成验证码</p>
</blockquote>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Java/"><i class="fa fa-tag fa-fw"></i>&nbsp;Java</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/07/29/动态规划入门/">
                
                    动态规划入门
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-07-29
        </time>
        
    
    <div class='cats'>
        <a href="/categories/算法/">算法</a>
    </div>


    </section>

    <section class="article typo">
        <h3 id="最长公共子序列"><a href="#最长公共子序列" class="headerlink" title="最长公共子序列"></a>最长公共子序列</h3><p><strong>参考邓俊辉老师《数据结构》的MOOC</strong></p>
<p><strong>理解问题</strong></p>
<p>两个序列的子序列指的是，由序列中的若干字符，按照原来的相对次序组成的。其中有几个注意事项</p>
<ul>
<li>可能同时有多个最长公共子序列，同时有多个意味着在不影响最长的前提下，在某个部分可能由不同的匹配结果，而几个 不同的匹配结果却不能合并，顺序是交叉的。用邓俊辉老师的例子是这样的：<ul>
<li>educational</li>
<li>advantage</li>
<li>前面匹配da没问题，倒着看匹配a没问题，中间可以匹配t也可以匹配n，不能同时匹配因为其出现次序不同</li>
</ul>
</li>
<li>可能有歧义，某一个字符同时出现两次<ul>
<li>didactical</li>
<li>advantage</li>
<li>data</li>
</ul>
</li>
</ul>
<p><strong>减而治之的思想得到递归程序</strong></p>
<ul>
<li>最简单最一般的情况就是其中有一个序列已经被减到空了，那么就不可能对应的序列了</li>
<li>在减小规模的过程中<ul>
<li>最后两个相等，就直接得到这个公共字符</li>
<li>最后两个不等<ul>
<li>分情况递归查找</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	<span class="comment">//最长公共子序列的递归算法</span></span><br><span class="line">	<span class="comment">//递归算法整体采用减而治之的思想</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">LCS</span><span class="params">(String str1,String str2,<span class="keyword">int</span> index1,<span class="keyword">int</span> index2)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//递归基，当其中有一个串已经完成的时候结束</span></span><br><span class="line">		<span class="keyword">if</span>(index1==-<span class="number">1</span>||index2==-<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//第一种情况，当末尾字符匹配的时候</span></span><br><span class="line">		<span class="keyword">if</span>(str1.charAt(index1)==str2.charAt(index2)) &#123;</span><br><span class="line">			<span class="keyword">return</span> LCS(str1,str2,index1-<span class="number">1</span>,index2-<span class="number">1</span>)+String.valueOf(str1.charAt(index1));</span><br><span class="line">			<span class="comment">//当不匹配的时候分成两种情况讨论，(分而治之)取其中最长的</span></span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			String a = LCS(str1,str2,index1-<span class="number">1</span>,index2);</span><br><span class="line">			String b = LCS(str1,str2,index1,index2-<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">return</span> a.length()&gt;=b.length()?a:b;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">LCS</span><span class="params">(String str1,String str2)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> LCS(str1,str2,str1.length()-<span class="number">1</span>,str2.length()-<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(LCS(<span class="string">"program"</span>, <span class="string">"algorithm"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>递归存在的问题</strong></p>
<p>减而治之已经带有大量重复计算的过程了，但是它又来了一个分而治之。。</p>
<p><strong>改进的策略</strong></p>
<p>类比斐波那契数列，斐波那契数列只用减而治之，改为迭代算法一方面可以对每一个计算结果进行保存，另一方面其计算结果依赖于前两项，对这两项从前到后的迭代也可以解决。LCS问题稍有不同的是，它有了分而治之，假设其所有的子问题都可以用M[A,B]A,B分别为子序列的长度。这些子问题构成的是一个二维的视图，求解M[A,B]在不能直接缩小问题规模的情况下（所谓直接缩小就是最后一个比对字符相等的情况下）就会比较M[A-1,B]和M[A,B-1]这两个问题的解谁大。</p>
<p>既然所有的子问题都可以用M[A,B]表示，设A的长度为m，B的长度为N，那么解决这些子问题远远比通过递归解决效率高得多。时间复杂度也是0(m*n)</p>
<p>这个表示解的二维数组的生成过程就是一个问题从最简单到复杂的过程。最简单的问题就是递归基表示的，其中有个序列为空了。之后就从左到右，从上到下扩展问题的规模。在下面的实现算法只表示LCS的字符的个数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">LCS</span><span class="params">(String str1,String str2)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span>[][] solve = <span class="keyword">new</span> <span class="keyword">int</span>[str1.length()+<span class="number">1</span>][str2.length()+<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;str1.length();i++) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;str2.length();j++) &#123;</span><br><span class="line">				<span class="keyword">if</span>(str1.charAt(i)==str2.charAt(j))</span><br><span class="line">					solve[i+<span class="number">1</span>][j+<span class="number">1</span>]=solve[i][j]+<span class="number">1</span>;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">int</span> a = solve[i][j+<span class="number">1</span>];</span><br><span class="line">					<span class="keyword">int</span> b = solve[i+<span class="number">1</span>][j];</span><br><span class="line">					solve[i+<span class="number">1</span>][j+<span class="number">1</span>]=a&gt;b?a:b;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> solve[str1.length()][str2.length()];</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在牛客网中查询相应的习题，对代码在其规定的环境中略作修改即可通过。</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/算法/"><i class="fa fa-tag fa-fw"></i>&nbsp;算法</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/07/28/Windows进程的创建过程/">
                
                    Windows进程的创建过程
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-07-28
        </time>
        
    
    <div class='cats'>
        <a href="/categories/操作系统/">操作系统</a>
    </div>


    </section>

    <section class="article typo">
        <h3 id="什么是进程？"><a href="#什么是进程？" class="headerlink" title="什么是进程？"></a>什么是进程？</h3><p>进程是空间上的概念，程序在内存中的一个抽象，包含程序的数据代码等等具体的内容。而线程是一个时间上的概念，我们在创建一个进程的时候一般同时创建一个线程，所以很容易在进程和线程的含义上区分不清楚。</p>
<h3 id="Windows进程创建过程"><a href="#Windows进程创建过程" class="headerlink" title="Windows进程创建过程"></a>Windows进程创建过程</h3><p>内存中的程序是其本身文件的映射。Windows的PE文件格式和Linux的ELF文件格式都是源于COFF文件格式，该格式是分段划分的，以满足对动态链接的要求以及对每个段数据的管理与保护，在32位操作系统下，windows 的PE文件格式会映射到一个2GB（低地址，高2G是操作系统占用的）大小的虚拟地址空间，这些地址空间由PE文件映射而来，同时加载许多动态库文件。对虚拟内存地址空间大致是如下的分布：</p>
<table>
<thead>
<tr>
<th>分区</th>
<th>32位windows</th>
</tr>
</thead>
<tbody>
<tr>
<td>空指针赋值区域</td>
<td>0x00000000-0x0000FFFF</td>
</tr>
<tr>
<td>用户模式区</td>
<td>0x00010000-0x7FFEFFFF</td>
</tr>
<tr>
<td>64KB禁入区</td>
<td>0x7FFF000-0x7FFFFFFF</td>
</tr>
<tr>
<td>内核</td>
<td>0x80000000-0xFFFFFFFF</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>下面是进程具体的创建过程：</p>
<ul>
<li>映射EXE文件</li>
<li>创建内核对象EPROCESS</li>
<li>映射系统DLL(ntdll.dll)</li>
<li>创建线程内核对象ETHREAD</li>
<li>系统启动线程<ul>
<li>映射DLL（ntdll.LdrlnitializeThunk）</li>
<li>线程开始执行</li>
</ul>
</li>
</ul>
<p>从大的方面来讲，分为两步，创建进程，创建线程</p>
<p>这两方面也都有共同点</p>
<ul>
<li>都对应着内核对象，分别是EPROCESS和ETHREAD，这些都是由操作系统管理，在OS的高2G当中</li>
<li>都需要映射dll，只不过进程是映射ntdll，线程启动时映射的是PE文件需要的dll，是递归加入的</li>
</ul>
<p>不同点在于</p>
<ul>
<li>线程需要操作系统启动。</li>
</ul>
<h3 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a>注意点：</h3><ul>
<li>进程都是由其他的进程创建的！第一个进程是由OS启动创建的。</li>
</ul>
<h3 id="CreateProcess"><a href="#CreateProcess" class="headerlink" title="CreateProcess"></a>CreateProcess</h3><p>在这里暂时不贴具体的API参数，而是先去大致学习明白它需要什么。</p>
<ul>
<li><p>子进程的概念</p>
<ul>
<li>由于进程都是由父进程创建（除了第一个创建的进程），所以引出子进程的概念</li>
</ul>
</li>
<li><p>创建子进程类似运行一个程序，类比命令行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir files/</span><br></pre></td></tr></table></figure>
<p>一个是这个程序路径和名字（得到程序在哪里，文件名对具体的文件索引是有一个映射的,文件名是对具体文件位置的抽象表示）</p>
<p>第二个是命令行参数，执行前的附加参数</p>
<p>第三个比较隐含，就是父进程的部分信息，这个“部分信息”包含以下内容：</p>
<ul>
<li>父进程的环境变量 -&gt;是否继承？</li>
<li>父进程信息 STARTUPINFO结构体（创建进程的时候由父进程填充），子进程通过GetStartupInfo来获取</li>
</ul>
</li>
<li><p>其次，我们应该去指明，创建这个进程的方式是什么？如何去创建。主要包含以下内容</p>
</li>
<li><p>最后，我们应该返回创建的进程和线程的标识信息，方便之后的程序步骤进行处理</p>
<ul>
<li>进程句柄，进程ID</li>
<li>线程句柄，线程ID</li>
</ul>
</li>
</ul>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/操作系统/"><i class="fa fa-tag fa-fw"></i>&nbsp;操作系统</a>
                
                    <a href="/tags/Windows/"><i class="fa fa-tag fa-fw"></i>&nbsp;Windows</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/07/27/Linux 学习（命令）/">
                
                    Linux学习（命令）
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-07-27
        </time>
        
    
    <div class='cats'>
        <a href="/categories/操作系统/">操作系统</a>
    </div>


    </section>

    <section class="article typo">
        <p>Linux常用命令的学习，不间断更新，逐渐让它完整</p>
<h2 id="Shell-操作"><a href="#Shell-操作" class="headerlink" title="Shell 操作"></a>Shell 操作</h2><ul>
<li>history<ul>
<li>显示之前输入过的命令</li>
<li>Ctrl+P 一直向上遍历（从下向上）  Previous</li>
<li>Ctrl+N 向下遍历 （也可以向上向下）Next</li>
</ul>
</li>
<li>光标控制<ul>
<li>Ctrl + B （Back Forward）</li>
<li>Ctrl + F（Forward）</li>
<li>Ctrl +D （Delete）删除光标盖住的（之后的）一个字符</li>
<li>Ctrl + U 删除光标前面的字符串</li>
<li>Ctrl + K 删除光标后面的字符串</li>
</ul>
</li>
<li>Tab 自动补全</li>
</ul>
<h2 id="文件目录结构"><a href="#文件目录结构" class="headerlink" title="文件目录结构"></a>文件目录结构</h2><ul>
<li>/<ul>
<li>/bin ：二进制文件,包含命令等等可执行程序（其中绿色的代表可执行程序，浅蓝色是软链接（快捷方式），红色是，要想显示颜色实际上执行的指令是ls –color=auto ）</li>
<li>/dev: device 在Linux下一切皆文件，里面包含了CPU，显卡，内存，显示器等设备的抽象</li>
<li>/lib：Linux运行的时候需要加载的一些动态库</li>
<li>/mnt: 手动挂载目录</li>
<li>/media: 自动挂载目录</li>
<li>/root ：Linux超级用户的家目录</li>
<li>/usr: unix system resource Unix系统资源目录<ul>
<li>/include 头文件</li>
<li>/game 游戏</li>
<li>/local 用户安装的应用程序目录</li>
</ul>
</li>
<li>/etc 配置文件<ul>
<li>/passed 存储的不是密码，是用户的信息</li>
<li>/group 存储用户组信息</li>
</ul>
</li>
<li>/opt: 安装第三方应用程序</li>
<li>/home 用户的家目录（宿主目录）</li>
<li>/tmp:   存放临时文件 重启清空</li>
</ul>
</li>
</ul>
<h2 id="命令学习（基本操作）"><a href="#命令学习（基本操作）" class="headerlink" title="命令学习（基本操作）"></a>命令学习（基本操作）</h2><h3 id="tree-gt-查看目录"><a href="#tree-gt-查看目录" class="headerlink" title="tree -&gt;(查看目录)"></a>tree -&gt;(查看目录)</h3><ul>
<li>查看一个目录的内容</li>
<li>tree 查看当前目录</li>
<li>tree dir 查看指定目录</li>
</ul>
<h3 id="ls-gt-（查看文件和目录）"><a href="#ls-gt-（查看文件和目录）" class="headerlink" title="ls  -&gt;（查看文件和目录）"></a>ls  -&gt;（查看文件和目录）</h3><ul>
<li>查看文件和目录</li>
</ul>
<p><strong>参数</strong></p>
<ul>
<li>-a   显示所有文件和目录，包括隐藏文件（以.开头的）</li>
<li>-l    列出详细信息<ul>
<li>-rwxrw-r– 1 kevin kevin 321145 11月 23 23:08 hello.txt</li>
<li>第一个字符：文件的类型<ul>
<li>7种</li>
<li>普通文件：-<ul>
<li>.txt 压缩包 可执行程序</li>
</ul>
</li>
<li>目录：d</li>
<li>符号链接：I</li>
<li>管道:p</li>
<li>套接字：s</li>
<li>字符设备：c<ul>
<li>键盘，鼠标</li>
</ul>
</li>
<li>块设备：b<ul>
<li>U盘，硬盘</li>
</ul>
</li>
</ul>
</li>
<li>之后就是文件所有者，文件所有组，其他人的权限</li>
<li>再之后的1是硬连接计数</li>
<li>在后来的用户名是文件所有者</li>
<li>再后来的名字是文件所属组的文字</li>
<li>后面的文字是文件的大小<ul>
<li>如果是目录，看到的大小永远是4K （ls -lh）是目录本身的大小</li>
</ul>
</li>
<li>日期</li>
<li>文件名</li>
</ul>
</li>
<li>-f 格式化，如果是目录就加/</li>
</ul>
<h3 id="alias-gt-（查看命令别名）"><a href="#alias-gt-（查看命令别名）" class="headerlink" title="alias -&gt;（查看命令别名）"></a>alias -&gt;（查看命令别名）</h3><p>常用的命令比如</p>
<p>ls =’ls –color=auto’</p>
<p>ll =’ls -alF’</p>
<h3 id="pwd-gt-（查看当前目录）"><a href="#pwd-gt-（查看当前目录）" class="headerlink" title="pwd -&gt;（查看当前目录）"></a>pwd -&gt;（查看当前目录）</h3><p>Print Work Dictionary</p>
<h3 id="cd-gt-（切换目录）"><a href="#cd-gt-（切换目录）" class="headerlink" title="cd -&gt;（切换目录）"></a>cd -&gt;（切换目录）</h3><ul>
<li>cd ~ 切换到家目录</li>
<li>cd 退出目录</li>
<li>cd - 最后两个相邻的，目录特别长的时候适用</li>
</ul>
<h3 id="mkdir-gt-创建目录"><a href="#mkdir-gt-创建目录" class="headerlink" title="mkdir -&gt;(创建目录)"></a>mkdir -&gt;(创建目录)</h3><ul>
<li>mkdir 文件名 ：直接创建路径</li>
<li>mkdir 路径/文件名 创建子目录</li>
<li>mkdir 路径/文件名 -p  可以一次性创建多级目录</li>
</ul>
<h3 id="touch-gt-（创建文件）"><a href="#touch-gt-（创建文件）" class="headerlink" title="touch -&gt;（创建文件）"></a>touch -&gt;（创建文件）</h3><ul>
<li>touch 文件名 如果文件不存在，创建新文件，如果存在，则会更新时间而不做任何操作</li>
</ul>
<h3 id="rmdir-gt-（删除空目录）"><a href="#rmdir-gt-（删除空目录）" class="headerlink" title="rmdir -&gt;（删除空目录）"></a>rmdir -&gt;（删除空目录）</h3><p>注意只能删除空目录，功能比较弱</p>
<h3 id="rm-gt-删除命令"><a href="#rm-gt-删除命令" class="headerlink" title="rm -&gt;(删除命令)"></a>rm -&gt;(删除命令)</h3><ul>
<li>删除目录<ul>
<li>直接删除也会提示’无法删除，是一个目录’</li>
<li>树形结构需要递归删除，因此需要加上参数-r</li>
</ul>
</li>
<li>删除文件<ul>
<li>rm 文件名 -i</li>
</ul>
</li>
<li><p>删除的时候给提示 -I</p>
</li>
<li><p>注意问题</p>
<ul>
<li>删除之后，很难恢复</li>
</ul>
</li>
</ul>
<h3 id="cp-gt-（拷贝）"><a href="#cp-gt-（拷贝）" class="headerlink" title="cp -&gt;（拷贝）"></a>cp -&gt;（拷贝）</h3><ul>
<li>cp 要拷贝的文件  拷贝目的  如果拷贝目的不存在则会创建这个文件并拷贝</li>
<li>cp file1 file2（存在）则会覆盖文件的内容</li>
<li>cp file dir（存在）<ul>
<li>拷贝file到dir<ul>
<li>cp dir dir1（存在）</li>
<li>将dir拷贝到dir1，直接使用会提示略过，拷贝时候需要递归的拷贝，所以应该加-r</li>
<li>cp dir dir1（不存在）</li>
<li>将dir里面的内容copy到新创建的目录中，注意不包括源dir名字</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="mv-gt-改名或者移动文件"><a href="#mv-gt-改名或者移动文件" class="headerlink" title="mv -&gt;(改名或者移动文件)"></a>mv -&gt;(改名或者移动文件)</h3><ul>
<li>改名<ul>
<li>mv file（存在）file1（不存在）</li>
<li>mv dir（存在）dir1（不存在）</li>
</ul>
</li>
<li>移动<ul>
<li>mv file（文件） dir（存在） 将file移动到目录中去</li>
<li>mv dir1（存在）dir2(存在) 将dir1移动到dir2中</li>
<li>mv file（存在）file2 覅了文件会覆盖file2文件</li>
</ul>
</li>
</ul>
<h3 id="cat-gt-（将内容打印到终端）"><a href="#cat-gt-（将内容打印到终端）" class="headerlink" title="cat -&gt;（将内容打印到终端）"></a>cat -&gt;（将内容打印到终端）</h3><p>文件特别多，大于终端显示上限，只能显示一部分</p>
<h3 id="more-gt-（查看更多）"><a href="#more-gt-（查看更多）" class="headerlink" title="more-&gt;（查看更多）"></a>more-&gt;（查看更多）</h3><ul>
<li>回车向下</li>
<li>空格翻页</li>
<li>不能回去</li>
<li>按下q退出</li>
</ul>
<h3 id="less-gt-（可以向上）"><a href="#less-gt-（可以向上）" class="headerlink" title="less-&gt;（可以向上）"></a>less-&gt;（可以向上）</h3><p>与more相同，但是可以向上翻页，可以用page up键也可以用Ctrl +P，向下Ctrl+N</p>
<h3 id="head-gt-（显示前？行）"><a href="#head-gt-（显示前？行）" class="headerlink" title="head -&gt;（显示前？行）"></a>head -&gt;（显示前？行）</h3><p>可以通过加入参数来设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">head -5 stdio.h</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认是10行</span></span><br></pre></td></tr></table></figure>
<h3 id="tail-gt-显示后？行"><a href="#tail-gt-显示后？行" class="headerlink" title="tail -&gt;(显示后？行)"></a>tail -&gt;(显示后？行)</h3><p>同上</p>
<h3 id="ln-gt-（创建快捷方式）"><a href="#ln-gt-（创建快捷方式）" class="headerlink" title="ln -&gt;（创建快捷方式）"></a>ln -&gt;（创建快捷方式）</h3><ul>
<li>软链接 –快捷方式<ul>
<li>ln -s </li>
<li>它的大小对应的是其字节数</li>
<li>当移动之后或许会发生快捷方式失效的，这是因为是相对路径</li>
<li>在创建的时候使用绝对路径就可以防止移动之后的快捷方式失效</li>
<li>目录也可以创建软链接</li>
</ul>
</li>
<li>硬连接 <ul>
<li>ln 文件名</li>
<li>相对路径或者绝对路径没有关系</li>
<li>认识inode结点<ul>
<li>磁盘上的数据块是由索引节点号inode来表示</li>
<li>OS并不对文件名感兴趣，每个文件是由其inode决定的</li>
<li>因此inode不占用磁盘空间</li>
<li>创建一个文件，硬链接计数为1</li>
<li>给文件创建了硬连接，链接+1，删除一个-1</li>
<li>如果inode为0，那么标识为废弃，再写入新文件的时候会覆盖，如果非0会进行保护</li>
</ul>
</li>
<li>使用场景<ul>
<li>磁盘上有一个文件</li>
<li>需要再其他多个目录管理这个文件，并且能够实时同步</li>
<li>硬连接是直接对应inode号，软链接是对应文件路径</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考资料：</p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html</a></p>
<p>理解 Linux 的硬链接与软链接</p>
</blockquote>
<h2 id="命令学习（用户权限，用户和用户组）"><a href="#命令学习（用户权限，用户和用户组）" class="headerlink" title="命令学习（用户权限，用户和用户组）"></a>命令学习（用户权限，用户和用户组）</h2><h3 id="chmod-gt-（修改文件或者目录的权限）"><a href="#chmod-gt-（修改文件或者目录的权限）" class="headerlink" title="chmod-&gt;（修改文件或者目录的权限）"></a>chmod-&gt;（修改文件或者目录的权限）</h3><ul>
<li><p>文字设定法</p>
<ul>
<li>chmod who[+|-|=]mode 文件名<ul>
<li>Who：<ul>
<li>u -User 文件所有者</li>
<li>g-group 文件所属组</li>
<li>o-other 其他人</li>
<li>a -all 所有人</li>
</ul>
</li>
<li>+|-|=</li>
<li>mode<ul>
<li>r:读</li>
<li>w:写</li>
<li>x:执行</li>
<li>-：没有任何权限</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有者添加读权限，同组用户减去执行权限</span></span><br><span class="line">chmod u+r,g-x file.c</span><br></pre></td></tr></table></figure>
</li>
<li><p>数字设定法</p>
<ul>
<li>chmod [+|-|=] mode 文件名<ul>
<li>mode：<ul>
<li>r: 100-&gt; 4</li>
<li>w:010-&gt;2</li>
<li>x:001-&gt;1</li>
<li>-:0</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="chown-gt-修改文件所有者或者所属组"><a href="#chown-gt-修改文件所有者或者所属组" class="headerlink" title="chown-&gt;(修改文件所有者或者所属组)"></a>chown-&gt;(修改文件所有者或者所属组)</h3><ul>
<li>chown 新的所有者 文件名</li>
<li>chown 新的所有者：新的组 文件名</li>
<li>如何查看用户和组？<ul>
<li>/etc/passwd 用户</li>
<li>/etc/group 组</li>
</ul>
</li>
<li>也可以修改组</li>
</ul>
<h3 id="chgrp-gt-（修改文件所有组）"><a href="#chgrp-gt-（修改文件所有组）" class="headerlink" title="chgrp-&gt;（修改文件所有组）"></a>chgrp-&gt;（修改文件所有组）</h3><p>只能修改对应的组</p>
<ul>
<li>chgrp 新的组 文件名</li>
</ul>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><ul>
<li>一个目录必须有可执行权限才能打开，否则就无法打开</li>
</ul>
<h3 id="文件的查找和检索"><a href="#文件的查找和检索" class="headerlink" title="文件的查找和检索"></a>文件的查找和检索</h3><h3 id="find-gt-根据文件属性查找"><a href="#find-gt-根据文件属性查找" class="headerlink" title="find-&gt;(根据文件属性查找)"></a>find-&gt;(根据文件属性查找)</h3><ul>
<li>文件名<ul>
<li>find 查找的目录 -name “查找的文件名”</li>
</ul>
</li>
<li>文件类型<ul>
<li>find 查找到目录 -type 文件类型<ul>
<li>Linux 下的七种文件类型<ul>
<li>普通文件（-），目录（d），磁盘链接（l），管道（p pipeline），套接字（s），字符设备（c），块设备（b）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>文件大小</p>
<ul>
<li>find 查找的目录 -size +10k      （查看大于10k的文件）</li>
<li>+:大于</li>
<li>-：小于</li>
<li>等于：直接写</li>
<li>单位：<ul>
<li>k - 小写</li>
<li>M-大写</li>
</ul>
</li>
<li>大于10k小于100k：find . -size +10k -size -100k</li>
</ul>
</li>
<li><p>按照日期</p>
<ul>
<li>创建日期： -ctime -n/+n<ul>
<li>-n:n天以内</li>
<li>+n：n天以外</li>
</ul>
</li>
<li>修改日期：-mtime</li>
<li>访问日期：-atime</li>
</ul>
</li>
<li>深度<ul>
<li>-maxdepth n(层数)搜索n层已下的目录</li>
<li>-mindepth n(层数)表示搜索n层以上的目录</li>
<li>-name 制定名字</li>
<li>find itcast/ -maxdepth 3 -name programer</li>
</ul>
</li>
<li>高级查找<ul>
<li>例，查找制定目录，并列出该目录中文件的详细信息<ul>
<li>find ./ -type d -exec ls -l {} \;</li>
<li>find ./ -type d -ok ls -l {} \;<ul>
<li>OK比较安全</li>
</ul>
</li>
<li>find ./-type d | xargs ls -l<ul>
<li>管道一端是Read端，一端是Write端</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="grep-gt-根据文件内容查找"><a href="#grep-gt-根据文件内容查找" class="headerlink" title="grep -&gt;(根据文件内容查找)"></a>grep -&gt;(根据文件内容查找)</h3><ul>
<li>搜索目录有子目录的时候需要加上-r</li>
<li>grep -r “查找的内容” 搜索的路径</li>
<li>搜索家目录中带有helloword字符串的文件</li>
<li>grep -r “helloworld” ~</li>
<li>显示在第几行 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -r <span class="string">"stdio.h"</span> ~ -n</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="压缩包管理"><a href="#压缩包管理" class="headerlink" title="压缩包管理"></a>压缩包管理</h3><ul>
<li><p>Linux下常见的压缩格式</p>
<ul>
<li>.gz –gzip<ul>
<li>压缩：gzip 文件1，文件2… -k(保留源文件)</li>
<li>解压缩：gunzip *.gz</li>
<li>不能压缩目录</li>
</ul>
</li>
<li>.bz2 -bzip</li>
</ul>
</li>
<li><p>常用压缩命令：</p>
<ul>
<li><p>tar -打包</p>
<ul>
<li><p>参数：</p>
<ul>
<li>c-创建压缩文件</li>
<li>x-释放压缩文件</li>
<li>v-打印提示信息</li>
<li>f-制定压缩包的名字</li>
<li>z-使用gzip压缩文件-&gt;xxx.tar.gz</li>
<li>j -使用bzip2的方式压缩文件-&gt;xxx.tar.bz2</li>
</ul>
</li>
<li><p>压缩</p>
<ul>
<li>tar 参数 压缩包名字 原材料。。。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zcvf test.tar.gz file1...</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压缩</p>
<ul>
<li>tar 参数 要解压包的名字</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf test.tar.gz</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>rar</p>
<ul>
<li>rar需要安装</li>
<li>压缩<ul>
<li>rar a 压缩包名（不需要指定后缀） 压缩的内容</li>
<li>注意压缩的时候是不压缩子目录的</li>
<li>所以就需要再后面加上-r</li>
</ul>
</li>
<li>解压缩<ul>
<li>rar x 压缩包名 解压的目录</li>
</ul>
</li>
</ul>
</li>
<li><p>zip/unzip</p>
<ul>
<li>压缩：<ul>
<li>zip 参数  压缩包名 原材料</li>
<li>如果有目录就是-r</li>
</ul>
</li>
<li>解压缩<ul>
<li>unzip 压缩包的名字 -d 解压目录</li>
<li>-O 制定编码 </li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="软件的安装与卸载（Ubnutu"><a href="#软件的安装与卸载（Ubnutu" class="headerlink" title="软件的安装与卸载（Ubnutu)"></a>软件的安装与卸载（Ubnutu)</h3><h3 id="apt-get在线安装"><a href="#apt-get在线安装" class="headerlink" title="apt-get在线安装"></a>apt-get在线安装</h3><ul>
<li>16.04版本之上就可以直接apt就可以</li>
<li>安装<ul>
<li>sudo apt-get install tree</li>
</ul>
</li>
<li>卸载<ul>
<li>sudo apt-get remove tree</li>
</ul>
</li>
<li>软件列表的更新<ul>
<li>sudo apt-get update</li>
<li>注意只是更新列表，列表是所有可安装程序的URL</li>
</ul>
</li>
<li>清空缓存<ul>
<li>sudo apt-get clean</li>
<li>对应的目录在var/cache/apt/archives</li>
<li>存储的是deb包</li>
</ul>
</li>
</ul>
<h3 id="deb软件包安装方式"><a href="#deb软件包安装方式" class="headerlink" title="deb软件包安装方式"></a>deb软件包安装方式</h3><ul>
<li>安装<ul>
<li>sudo dpkg -i  xxx.deb</li>
<li>sudp dpkg -r 软件名</li>
</ul>
</li>
</ul>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Linux/"><i class="fa fa-tag fa-fw"></i>&nbsp;Linux</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/07/27/Linux系统函数学习（更新中）/">
                
                    Linux系统函数学习
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-07-27
        </time>
        
    
    <div class='cats'>
        <a href="/categories/操作系统/">操作系统</a>
    </div>


    </section>

    <section class="article typo">
        <p>Linux系统函数的学习，不间断更新，直到完整</p>
<h3 id="从fopen看文件FILE结构体"><a href="#从fopen看文件FILE结构体" class="headerlink" title="从fopen看文件FILE结构体"></a>从fopen看文件FILE结构体</h3><p>​    在使用fopen打开文件返回的是FILE结构体，之前并不了解其内部，只是大致会用而已，在这里首先剖析FILE结构体。</p>
<p>FILE结构体的内容很多，主要分为以下部分</p>
<p>FILE</p>
<ul>
<li><p>文件描述符（整形值）FD</p>
<ul>
<li>文件描述符内部有inode信息，再通过inode找到具体的文件</li>
</ul>
</li>
<li><p>文件读写指针位置  FP_POS</p>
<ul>
<li><p>首先读写指针是一个指针，因此在切换读写文件的时候需要fseek来移动文件指针</p>
</li>
<li><p>对于文件读写是对应的二进制读取，文本文件读取信息的资料补充</p>
<blockquote>
<p>知乎：fopen 为什么要区分文本模式和二进制模式？</p>
<p><a href="https://www.zhihu.com/question/24662572" target="_blank" rel="noopener">https://www.zhihu.com/question/24662572</a></p>
<p>牵扯到了BOM，下面为总结：</p>
<p>BOM（byte-order mark）它用来标识该字节流的字节序，是高位在前还是低位在前。从Unicode3.2开始，BOM只能位于流的开头，只能用于标识字节序。</p>
<p>UTF-8: 若为UTF-8有BOM格式，则文件开头为 EF BB BF； 若为UTF-8无BOM格式，则不能依据上述规则；此时需要依据UTF-8编码格式来判断</p>
</blockquote>
</li>
</ul>
</li>
<li><p>I/O缓冲区（内存地址）BUFFER<br><img src="https://upload-images.jianshu.io/upload_images/8852615-0539b579f780a484.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ScreenShot_20180720193704.png"></p>
<ul>
<li>C标准函数都有Buffer</li>
<li>I/O缓存区域，根据存储器层次结构，硬盘会比内存慢100万倍，因此要增设缓存，默认是8K，同样需要注意的是IO的形式除了默认的，还有以下形式：<ul>
<li>直接IO<ul>
<li>内存映射文件的形式</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>读写过程：</p>
<ul>
<li>例如Printf(“Hello World”);</li>
<li>调用write函数将文件描述符传入（系统API write(fd,”hello”,5)）完成将”hello”用户空间到内核空间的传递</li>
<li>系统调用sys_write 使用设备驱动，通过设备驱动函数写入到驱动操作硬件</li>
<li>显示器显示</li>
</ul>
<h3 id="虚拟地址空间"><a href="#虚拟地址空间" class="headerlink" title="虚拟地址空间"></a>虚拟地址空间</h3><p>32位操作系统当一个可执行文件允许起来成为一个进程的时候操作系统会为其分配一个4G的地址空间，虚拟内存是分段的，而其根据局部性原理也不是一次性加载的，而是分页的</p>
<p>下面是对虚拟地址空间做一个详细的总结，虚拟地址空间的引出和计算机的发展历程是离不开的的。</p>
<p>在早期的计算机中，程序是直接运行在物理内存上的，程序直接访问的是物理地址，这种模式的限制在于，只要程序要求的内存空间不要超过超过物理内存的大小，就不会有问题，但是为了提高CPU的使用效率，我们更期望的是同时运行多个程序，现在关键的问题在于，能运行的程序受限于物理内存的大小以及运行程序本身的大小。所以一个需要关键解决的问题就是如何将有限的物理内存分配给多个程序使用，也就是内存分配问题，但除了内存分配问题，传统的方式还存在许多问题。</p>
<ul>
<li>地址空间不隔离导致程序的安全性不足，一个程序的崩溃会影响到其他程序，恶意程序可以轻松修改其他程序的数据，总而言之，缺乏安全稳定性</li>
<li>内存地址分配随机就让程序内部的重定位工作（运行地址不确定）变得异常麻烦</li>
<li>内存使用效率低下</li>
<li><p>内存切换过程（将完整程序换入到硬盘或者将完整换出）效率十分低下</p>
<p>如果引入一个中间层，在外部忽视内存地址的差异，在内部执行一个转换到真实地址的过程，就可以轻松解决第一第二点，这就是虚拟内存。虚拟内存使得应用程序不需要考虑自己加载到什么地方。相互之间也起到了隔离的作用，程序与程序之间安全性得到了一定的保障。但是第三个第四个仍然没有解决。内存毕竟是有限的。为了能让在内存的程序尽可能的多，当然是程序占用内存越小越好，但是程序变小不可能的。但这个思路得以运用，将程序加载到内存的粒度缩小，采用分页模式就有效的解决的这个问题。</p>
<p>在以上的描述中，并没有深入研究CPU如何做到将虚拟内存映射到实际内存的过程，也没有研究页是如何被操作系统管理，缺页的时候怎么办等等，这个在之后学习。</p>
</li>
</ul>
<p>程序都是按照一定格式存储的，由操作系统统一加载。在内存中映射为4GB的虚拟内存空间（32位）这样的文件格式是分段的，很好的解决了一些资源共享的问题，比如动态库的共享，也为每一个应用程序提供了一个统一的视图，完成功能，下面是Linux的ELF文件在内存的映射</p>
<ul>
<li>内核区：内存管理，进程管理，设备驱动管理，VFS虚拟文件系统（4G-3G linux）</li>
<li>环境变量 env</li>
<li>命令行参数  <ul>
<li>int main(int argc,char* argv[])中的参数</li>
</ul>
</li>
<li>栈空间（小）向下增长</li>
<li>共享库</li>
<li>堆空间（大）向上增长</li>
<li>.bass（未初始化的全局变量）全局变量=0</li>
<li>.data（已初始化全局变量）</li>
<li>.text（代码段 二进制机器指令）</li>
<li>受保护的地址（0-4K）其中0是收保护的地址，这也就是NULL的作用</li>
</ul>
<h3 id="文件描述符表"><a href="#文件描述符表" class="headerlink" title="文件描述符表"></a>文件描述符表</h3><p>内核进程管理里面由一个叫做PCB(进程控制块)每个进程都在其PCB中保存着一份文件描述符表，而文件描述符作为这个表的索引可以让我们快速的查到每个表项对应的打开文件的指针，文件描述符表最多可以存储1024个文件描述符</p>
<p><strong>用户不能直接访问具体的文件描述符，就只能通过文件描述符表的下标由内核函数访问。</strong></p>
<p>文件描述符前3个分别是STDIN_FILENO 标准输入 STDOUT_FILENO 标准输出 STDERR_FILENO 标准错误默认是打开状态，根据该文件描述符可以读写当前终端，每打开一个新文件，则占用一个文件描述符，而且是空闲的最小的一个文件描述符</p>
<p>文件描述符内含有inode信息，具体的介绍查看:</p>
<blockquote>
<p><a href="http://www.docin.com/p-941544538.html" target="_blank" rel="noopener">http://www.docin.com/p-941544538.html</a></p>
<p>豆丁网-inode,文件描述符</p>
</blockquote>
<p>Linux的open函数返回的int类型就是文件描述符表对新创建文件的下标，也就是文件描述符</p>
<p>而系统函数read传入文件描述符，就可以清楚的知道要操作哪一个文件。</p>
<h2 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h2><p>系统函数在man帮助文档的第二章</p>
<h3 id="Open函数"><a href="#Open函数" class="headerlink" title="Open函数"></a>Open函数</h3><p>查看文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man 2 open</span><br></pre></td></tr></table></figure>
<p>头文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt; //宏定义</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>open函数看起来是函数重载的原因是使用了变长参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* pathnamae,<span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"><span class="comment">//第三个参数是在第二个参数有效的情况下才有意义</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* pathname,<span class="keyword">int</span> flags,<span class="keyword">mode_t</span> mode)</span></span>;</span><br></pre></td></tr></table></figure>
<p>返回值：文件描述符，失败返回-1</p>
<p><strong>参数</strong></p>
<ul>
<li>flags<ul>
<li>必选项目 O_RDONLY,O_WRONLY,O_RDWR</li>
<li>可选项目<ul>
<li>创建文件：O_CREATE<ul>
<li>创建文件时检测文件是否存在：O_EXCL</li>
<li>如果文件存在，返回-1</li>
<li>必须与O_CREAT一起使用</li>
</ul>
</li>
<li>追加文件：O_APPEND:文件指针移动到末尾</li>
<li>文件截断：O_TRUNC ：做文件清空的情况</li>
<li>设置非阻塞：O_NONBLOCK</li>
</ul>
</li>
</ul>
</li>
<li>mode 八进制文件权限<ul>
<li>注意设置的权限不等于最终的权限值</li>
<li>（mode&amp;~umask）</li>
<li>umask是0002</li>
</ul>
</li>
</ul>
<h3 id="close函数"><a href="#close函数" class="headerlink" title="close函数"></a>close函数</h3><p>关闭文件描述符</p>
<h3 id="read函数"><a href="#read函数" class="headerlink" title="read函数"></a>read函数</h3><h3 id="write函数"><a href="#write函数" class="headerlink" title="write函数"></a>write函数</h3>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Linux/"><i class="fa fa-tag fa-fw"></i>&nbsp;Linux</a>
                
                    <a href="/tags/操作系统/"><i class="fa fa-tag fa-fw"></i>&nbsp;操作系统</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/07/27/Java反射基础/">
                
                    Java反射基础
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-07-27
        </time>
        
    
    <div class='cats'>
        <a href="/categories/Java/">Java</a>
    </div>


    </section>

    <section class="article typo">
        <p>Java反射机制的学习</p>
<h2 id="什么是反射？"><a href="#什么是反射？" class="headerlink" title="什么是反射？"></a>什么是反射？</h2><blockquote>
<p>JAVA反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意方法和属性；这种动态获取信息以及动态调用对象方法的功能称为java语言的反射机制。 –百度百科</p>
</blockquote>
<h2 id="Class类-反射的根源"><a href="#Class类-反射的根源" class="headerlink" title="Class类 - 反射的根源"></a>Class类 - 反射的根源</h2><h3 id="Class类描述"><a href="#Class类描述" class="headerlink" title="Class类描述"></a>Class类描述</h3><p>Class类是对应类文件的描述，可以说是class字节码的抽象，这种描述包含：类名、构造函数以及成员函数、属性，它是对应对象的模板，用它可以去实例化类类对象。</p>
<h3 id="得到Class类的三种方法"><a href="#得到Class类的三种方法" class="headerlink" title="得到Class类的三种方法"></a>得到Class类的三种方法</h3><ul>
<li>Object中有getClass方法。</li>
<li>一个具体的类.class</li>
<li>通过Class类中的静态方法forName。<h3 id="使用Class来实例化对象"><a href="#使用Class来实例化对象" class="headerlink" title="使用Class来实例化对象"></a>使用Class来实例化对象</h3></li>
<li>使用newInstance来实例化，该对象调用的是无参数的构造方法，如果没有默认的构造方法就会报错！因此在使用反射框架的时候注意尽量保留默认构造方法。</li>
<li><p>使用getConstructors用有参的方式来进行实例化<br>该方法返回所有的构造方法。返回的是一个Constructor对象的数组,Constructor对象包含函数名信息，参数个数等等：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ref</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class&lt;Dog&gt; dogClass = Dog.class;</span><br><span class="line">        Constructor[] constructors = dogClass.getConstructors();</span><br><span class="line">        <span class="keyword">for</span>(Constructor constructor:constructors)&#123;</span><br><span class="line">            System.out.println(constructor.getName());<span class="comment">//名字</span></span><br><span class="line">            System.out.println(constructor.getParameterCount());<span class="comment">//参数个数</span></span><br><span class="line">            Class[] classes = constructor.getParameterTypes();<span class="comment">//参数类型</span></span><br><span class="line">            <span class="keyword">for</span>(Class _class:classes)&#123;</span><br><span class="line">                System.out.println(_class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用getConstructor来获取制定的构造器。</p>
</li>
<li>获取构造器中可以使用newInstance来进行初始化。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dog dog = (Dog)constructor.newInstance(<span class="number">1</span>,<span class="string">"Hello"</span>);</span><br><span class="line">System.out.println(dog);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="访问属性"><a href="#访问属性" class="headerlink" title="访问属性"></a>访问属性</h3><p> 通过getFiled属性来得到属性，返回Filed[]对象，注意这样得到的只能是共有的属性。如果是想得到全部的属性值需要使用getDeclaredFileds方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Dog类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name=<span class="string">"NULL"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id+<span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ref</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Field[] fields = Dog.class.getFields();</span><br><span class="line">        Field[] fields1 = Dog.class.getDeclaredFields();</span><br><span class="line">        System.out.println(fields.length);</span><br><span class="line">        System.out.println(fields1.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>得到Field对象之后可以得到相应的属性与方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       Field[] fields = Dog.class.getFields();</span><br><span class="line">       Field[] fields1 = Dog.class.getDeclaredFields();</span><br><span class="line">       <span class="keyword">for</span>(Field field:fields1)&#123;</span><br><span class="line">           System.out.println(field.getName());<span class="comment">//得到名字</span></span><br><span class="line">           System.out.println(field.getDeclaringClass());<span class="comment">//得到类</span></span><br><span class="line">           System.out.println(field.getModifiers());<span class="comment">//得到修饰符，返回是int</span></span><br><span class="line">           System.out.println(Modifier.toString(field.getModifiers()));<span class="comment">//通过Modifier的静态方法转换</span></span><br><span class="line">          <span class="comment">// System.out.println(field.);</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="获取包的信息"><a href="#获取包的信息" class="headerlink" title="获取包的信息"></a>获取包的信息</h3><p>得到包需要使用到Class类中的getPackage的方法，返回一个Package对象可以通过Package对象的方法得到其中的具体信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;Dog&gt; dogClass = Dog.class;</span><br><span class="line">Package pack = dogClass.getPackage();</span><br><span class="line">System.out.println(pack.getName());</span><br></pre></td></tr></table></figure></p>
<h3 id="获得方法"><a href="#获得方法" class="headerlink" title="获得方法"></a>获得方法</h3><p>对应Method对象，通过getMethods方法可以得到所有的公共的方法，包括继承的公有方法，如果想要获取私有方法，就通过getDeclaredMethods方法，但是直接执行是不行的，由于是private的限制，但是这个总是有办法去解决的，就是对Method执行setAccessible函数来设置为true（暴力执行）。方法的到之后我们需要执行，执行函数是invoke方法的作用，执行函数是依赖与具体对象的，除了传入对象当然还有具体的参数。上面都是得到方法的数组，得到具体的方法就把后面的s去掉即可。<br>下面是一个简单的Demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sayByebye</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ByeBye:"</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ref</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException, InvocationTargetException </span>&#123;</span><br><span class="line">        Class&lt;Test&gt; test = Test.class;</span><br><span class="line">        Test obj =(Test) test.newInstance();</span><br><span class="line">        Method[] methods = test.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span>(Method method:methods)&#123;</span><br><span class="line">            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            method.invoke(obj,<span class="string">"HelloWorld!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>### </p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Java/"><i class="fa fa-tag fa-fw"></i>&nbsp;Java</a>
                
                    <a href="/tags/反射/"><i class="fa fa-tag fa-fw"></i>&nbsp;反射</a>
                
            </div>
        
    </section>
</article>

        </div>
    
        <div class='post-wrapper'>
            <article class="post reveal ">
    <section class="meta">
        <h2 class="title">
            <a href="/2018/07/27/Servlet执行过程/">
                
                    Servlet 执行过程笔记
                
            </a>
        </h2>
        <time>
            <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;2018-07-27
        </time>
        
    
    <div class='cats'>
        <a href="/categories/Java/">Java</a>
    </div>


    </section>

    <section class="article typo">
        <p>首先必须明确，Servlet是JavaEE一个规范，包括JDBC，都是提供了一个规范，而Servlet的具体实现以及运行过程是Tomcat来具体进行的。Servlet本身就是一个接口。HttpServlet只是它的一个具体的实现。</p>
<h2 id="Web容器"><a href="#Web容器" class="headerlink" title="Web容器"></a>Web容器</h2><p>Web容器说白了就是Web服务器，Tomcat在收到客户端发来的请求之后，创建HttpServletRequest，HttpServletResponse等，它得到请求信息封装起来，交给Servlet去处理。</p>
<h2 id="Servlet容器"><a href="#Servlet容器" class="headerlink" title="Servlet容器"></a>Servlet容器</h2><p>在Tomcat启动之后也会初始化一个Servlet容器，其会检索web.xml或者是注解来生成ServletConfig对象，ServletConfig本身也是接口，其定义了获取在web.xml或者注解中指明的参数。其接口的具体方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletConfig</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getInitParameterNames</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Servlet 接口则指明了Servlet生命期的几个关键的函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Servlet</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span><span class="keyword">throws</span> ServletExection</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span><span class="keyword">throws</span> ServletException, IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，Tomcat规定了如何调用整个Servlet过程，这就是具体的算法。</p>
<ul>
<li>init 方法在Servlet生命周期中的初始化阶段被调用</li>
<li>servlet初始化后，有了新的请求调用service方法，进行处理，如HttpServlet 进行doGet和doPost方法的判断。</li>
<li>当销毁servlet对象的时候，调用distory方法释放被占用的资源 </li>
</ul>
<p>ServletConfig和Servlet封装了这个过程中容易变化的部分。再定义一个抽象类将算法封装起来，这就是所谓的模板方法模式，封装算法的抽象类是GenericServlet，我们查看GenericServlet的具体内容。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericServlet</span> <span class="keyword">implements</span> <span class="title">Servlet</span>, <span class="title">ServletConfig</span>,</span></span><br><span class="line"><span class="class">        <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="comment">//这里组合了一个ServletConfig对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletConfig config;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getServletConfig().getInitParameter(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getInitParameterNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getServletConfig().getInitParameterNames();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getServletConfig().getServletContext();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    	<span class="keyword">this</span>.config = config;</span><br><span class="line">        <span class="keyword">this</span>.init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// NOOP by default</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        getServletContext().log(getServletName() + <span class="string">": "</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String message, Throwable t)</span> </span>&#123;</span><br><span class="line">        getServletContext().log(getServletName() + <span class="string">": "</span> + message, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException</span>;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config.getServletName();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个封装算法的抽象类描述的是什么？<br>首先它实现了 Servlet, ServletConfig,Serializable，自然封装了Servlet和ServletConfig所描述的算法，这里实现ServletConfig的实现比较有意思，它是组合了一个ServletConfig对象，然后间接调用这个对象的方法来实现具体ServletConfig接口指明的方法。</p>
<h2 id="整个调用过程"><a href="#整个调用过程" class="headerlink" title="整个调用过程"></a>整个调用过程</h2><ul>
<li>Web服务器接受到HTTP请求</li>
<li>web容器生成对象，将请求转发给Servlet容器</li>
<li>如果容器中不存在对应的Servlet，那么Servlet容器就会去检索，加载，调用init方法，如果有直接进行下一步。</li>
<li>容器调用Servlet的service方法来处理HTTP请求</li>
<li>Web服务器返回信息给客户</li>
</ul>
<h2 id="其他注意点"><a href="#其他注意点" class="headerlink" title="其他注意点"></a>其他注意点</h2><p>loadonstartup指明是否在Servlet容器启动的时候就进行初始化，其值代表一个优先级顺序。</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Java-Servlet/"><i class="fa fa-tag fa-fw"></i>&nbsp;Java Servlet</a>
                
            </div>
        
    </section>
</article>

        </div>
    
</section>


    <br>
    <div class="prev-next">
        <div class="prev-next">
            
                <a class="prev" rel="prev" href="/page/2/">
                    <section class="post prev" >
                        <i class="fa fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页&nbsp;
                    </section>
                </a>
            
            <p class="current">
                3 / 4
            </p>
            
                <a class="next" rel="next" href="/page/4/">
                    <section class="post next">
                        &nbsp;下一页&nbsp;<i class="fa fa-chevron-right" aria-hidden="true"></i>
                    </section>
                </a>
            

        </div>
    </div>



        </div>
        <aside class='l_side'>
            
    
        
    <section class='m_widget author'>
        
            <div class='header'>
                <img class='avatar' src='https://xaoxuu.com/assets/img/avatar.jpg' />
            </div>
        
        
            <div class='content'>
                
                    <h2>飞翔的傻瓜</h2>
                
                
                    <div>
                        <i class="fa fa-quote-left fa-3x fa-pull-left" aria-hidden="true"></i>
                        一点一点往上爬
                    </div>
                
            </div>
        
        
    </section>


    
    
        <section class='m_widget categories'>
    <div class='header'><i class="fa fa-sitemap fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;分类</div>
    <div class='content'>
        
            <ul class="entry">
                
                    <li><a class="flat-box" href="/categories/C-C/"><div class='name'>C/C++</div><div class='badge'>1</div></a></li>
                
                    <li><a class="flat-box" href="/categories/Java/"><div class='name'>Java</div><div class='badge'>9</div></a></li>
                
                    <li><a class="flat-box" href="/categories/JavaScript/"><div class='name'>JavaScript</div><div class='badge'>8</div></a></li>
                
                    <li><a class="flat-box" href="/categories/Tools/"><div class='name'>Tools</div><div class='badge'>1</div></a></li>
                
                    <li><a class="flat-box" href="/categories/操作系统/"><div class='name'>操作系统</div><div class='badge'>6</div></a></li>
                
                    <li><a class="flat-box" href="/categories/算法/"><div class='name'>算法</div><div class='badge'>3</div></a></li>
                
                    <li><a class="flat-box" href="/categories/设计模式/"><div class='name'>设计模式</div><div class='badge'>4</div></a></li>
                
            </ul>
        
    </div>
</section>

    
    
        
    <section class='m_widget tagcloud'>
        <div class="header"><i class="fa fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;标签</div>
        <div class='content'>
            <a href="/tags/C/" style="font-size: 14px; color: #999">C</a> <a href="/tags/ClassLoader/" style="font-size: 14px; color: #999">ClassLoader</a> <a href="/tags/Git/" style="font-size: 14px; color: #999">Git</a> <a href="/tags/Java/" style="font-size: 24px; color: #555">Java</a> <a href="/tags/Java-Servlet/" style="font-size: 14px; color: #999">Java Servlet</a> <a href="/tags/JavaScript/" style="font-size: 24px; color: #555">JavaScript</a> <a href="/tags/Linux/" style="font-size: 17.33px; color: #828282">Linux</a> <a href="/tags/NIO/" style="font-size: 14px; color: #999">NIO</a> <a href="/tags/Server杂项/" style="font-size: 14px; color: #999">Server杂项</a> <a href="/tags/Windows/" style="font-size: 14px; color: #999">Windows</a> <a href="/tags/jdbc/" style="font-size: 14px; color: #999">jdbc</a> <a href="/tags/保护模式/" style="font-size: 14px; color: #999">保护模式</a> <a href="/tags/前端/" style="font-size: 14px; color: #999">前端</a> <a href="/tags/反射/" style="font-size: 14px; color: #999">反射</a> <a href="/tags/操作系统/" style="font-size: 20.67px; color: #6c6c6c">操作系统</a> <a href="/tags/栈-队列-算法/" style="font-size: 14px; color: #999">栈 队列 算法</a> <a href="/tags/注解/" style="font-size: 14px; color: #999">注解</a> <a href="/tags/算法/" style="font-size: 14px; color: #999">算法</a> <a href="/tags/算法-递归/" style="font-size: 14px; color: #999">算法 递归</a> <a href="/tags/设计模式/" style="font-size: 14px; color: #999">设计模式</a> <a href="/tags/设计模式-动态代理/" style="font-size: 14px; color: #999">设计模式 动态代理</a> <a href="/tags/设计模式-策略模式/" style="font-size: 14px; color: #999">设计模式 策略模式</a> <a href="/tags/设计模式-观察者模式/" style="font-size: 14px; color: #999">设计模式 观察者模式</a>
        </div>
    </section>


    
    
        <section class='m_widget music'>
    <div class='header'><i class="fa fa-headphones fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;音乐</div>
    <div class='content'>
        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=450 src="//music.163.com/outchain/player?type=0&id=2494951909&auto=0&height=450"></iframe>
    </div>
</section>

    
    
        <section class='m_widget links'>
    <div class='header'><i class="fa fa-handshake-o fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;友链</div>
    <div class='content'>
        <ul class="entry" id="links">
            
                <li><a class="flat-box" target="_blank" rel="external nofollow noopener noreferrer" href="http://www.codergzw.com">
                    <div class='name'>
                        <i class="fa fa-user-circle-o fa-fw" aria-hidden="true"></i>
                        &nbsp;&nbsp;GuoZW的博客
                    </div>
                </a></li>
            
                <li><a class="flat-box" target="_blank" rel="external nofollow noopener noreferrer" href="http://codermiya.com/">
                    <div class='name'>
                        <i class="fa fa-user-circle-o fa-fw" aria-hidden="true"></i>
                        &nbsp;&nbsp;Miyang的博客
                    </div>
                </a></li>
            
            

        </ul>

    </div>
</section>

    
    
        

    


        </aside>
        <script>setLoadingBarProgress(60);</script>
    </div>
    </div>
    <footer id="footer" class="clearfix">
    
        <div class="social-wrapper">
          
              
                  <a href="mailto:me@xaoxuu.com" class="social fa fa-envelope flat-box" target="_blank" rel="external"></a>
              
          
              
                  <a href="https://github.com/xaoxuu" class="social fa fa-github flat-box" target="_blank" rel="external"></a>
              
          
              
          
              
          
              
          
              
                  <a href="https://music.163.com/#/user/home?id=63035382" class="social fa fa-music flat-box" target="_blank" rel="external"></a>
              
          
              
                  <a href="atom" class="social fa fa-rss flat-box" target="_blank" rel="external"></a>
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
        </div>
    
    <br>
    <div>博客内容遵循 <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="licenses">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></div>
    <div>本站使用 <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a> 作为主题，
		总访问量为 <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次。
    </div>
</footer>
<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->


    <script>setLoadingBarProgress(80);</script>
    <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<!-- 访问统计 -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/jquery.fitvids.js"></script>

    <script>
        var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
        var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
        var ALGOLIA_API_KEY = "";
        var ALGOLIA_APP_ID = "";
        var ALGOLIA_INDEX_NAME = "";
        var AZURE_SERVICE_NAME = "";
        var AZURE_INDEX_NAME = "";
        var AZURE_QUERY_KEY = "";
        var BAIDU_API_ID = "";
        var SEARCH_SERVICE = "hexo" || "hexo";
        var ROOT = "/"||"/";
        if(!ROOT.endsWith('/'))ROOT += '/';
    </script>

<script src="/js/search.js"></script>
<script src="/js/app.js"></script>



    <script>setLoadingBarProgress(100);</script>
</body>
